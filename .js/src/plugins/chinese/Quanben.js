var t=this&&this.__assign||function(){return t=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},t.apply(this,arguments)},e=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(a,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,s)}c((r=r.apply(t,e||[])).next())}))},n=this&&this.__generator||function(t,e){var n,r,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(i=0)),i;)try{if(n=1,r&&(a=2&s[0]?r.return:s[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,s[1])).done)return a;switch(r=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],r=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("@libs/fetch"),a=require("@libs/novelStatus"),i=require("cheerio"),o=require("@libs/defaultCover"),s=function(t,e){if(t)try{return t.startsWith("//")?"https:"+t:t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(t){return}},c=function(){function c(){this.id="quanben",this.name="Quanben",this.site="https://www.quanben.io/",this.version="1.0.0",this.icon="src/cn/quanben/icon.png",this.defaultCover=o.defaultCover,this.filters={}}return c.prototype.popularNovels=function(t){return e(this,void 0,void 0,(function(){var t,e,a,o,c,u,h=this;return n(this,(function(n){switch(n.label){case 0:return t=this.site+"amp/",[4,(0,r.fetchApi)(t)];case 1:if(!(e=n.sent()).ok)throw new Error("[Quanben] Failed to fetch AMP popular novels page: ".concat(t," - Status: ").concat(e.status));return[4,e.text()];case 2:return a=n.sent(),o=(0,i.load)(a),c=[],u=new Set,o("div.box").each((function(t,e){var n,r,a=o(e),i=a.find("div.list2");if(i.length>0){var l=i.find("h3 > a"),p=null===(n=l.attr("href"))||void 0===n?void 0:n.trim(),f=l.text().trim(),d=null===(r=i.find("amp-img").attr("src"))||void 0===r?void 0:r.trim(),v=s(d,h.site)||h.defaultCover;p&&f&&!u.has(p)&&(c.push({name:f,path:p,cover:v}),u.add(p))}a.find("ul.list li").each((function(t,e){var n,r=o(e).find("a"),a=null===(n=r.attr("href"))||void 0===n?void 0:n.trim(),i=r.find("span").first().text().trim();a&&i&&!u.has(a)&&(c.push({name:i,path:a,cover:h.defaultCover}),u.add(a))}))})),[2,c]}}))}))},c.prototype.parseNovel=function(t){return e(this,void 0,void 0,(function(){var e,o,c,u,h,l,p,f,d;return n(this,(function(n){switch(n.label){case 0:if(!t||!t.startsWith("/amp/n/")||!t.endsWith("/"))throw new Error('[Quanben parseNovel] Invalid novelPath received: "'.concat(t,'". Expected AMP format: "/amp/n/novel-name/"'));if(!(e=s(t,this.site)))throw new Error("[Quanben parseNovel] Could not construct full AMP novel URL from path: ".concat(t));return[4,(0,r.fetchApi)(e)];case 1:if(!(o=n.sent()).ok)throw new Error("[Quanben parseNovel] Failed to fetch AMP novel page: ".concat(e," - Status: ").concat(o.status));return[4,o.text()];case 2:return c=n.sent(),u=(0,i.load)(c),h=u("div.list2"),l=u("div.description"),p={path:t,name:h.find("h3").text().trim()||u('h1[itemprop="name headline"]').text().trim()||"Unknown Novel Name",cover:s(h.find("amp-img").attr("src"),this.site)||this.defaultCover,summary:l.find("p").text().trim()||l.text().trim()||void 0,author:h.find("p:contains('作者:') span").text().trim()||void 0,status:a.NovelStatus.Unknown,genres:h.find("p:contains('类别:') span").text().trim()||void 0,chapters:[]},(f=h.find("p:contains('状态:') span").text().trim()||h.text()).includes("完结")||f.includes("已完成")?p.status=a.NovelStatus.Completed:(f.includes("连载中")||f.includes("进行中"))&&(p.status=a.NovelStatus.Ongoing),d=p,[4,this.parseChapterList(t)];case 3:return d.chapters=n.sent(),[2,p]}}))}))},c.prototype.parseChapterList=function(a){return e(this,void 0,void 0,(function(){var e,o,c,u,h,l,p,f,d,v=this;return n(this,(function(n){switch(n.label){case 0:return a&&a.startsWith("/amp/n/")&&a.endsWith("/")&&(e=s(a+"list.html",this.site))?[4,(0,r.fetchApi)(e)]:[2,[]];case 1:return(o=n.sent()).ok?[4,o.text()]:[2,[]];case 2:return c=n.sent(),u=(0,i.load)(c),h=[],(l=a.match(/(\/n\/[^\/]+\/)/))&&l[1]?(p=l[1].replace(/^\/n\/|\/$/g,""),u("ul.list3 li a").each((function(t,e){var n=u(e),r=n.text().trim(),a=n.attr("href");if(r&&a){var i=function(t){if(t)try{var e=new URL(t).pathname.split("/"),n=e[e.length-1];return n&&/^\d+\.html$/.test(n)?n:void 0}catch(t){return}}(s(a,v.site));if(i){var o=p+"/"+i;h.push({name:r,path:o})}}})),f=new Map,h.forEach((function(t){f.has(t.path)||f.set(t.path,t)})),(d=Array.from(f.values())).sort((function(t,e){var n,r;return parseInt((null===(n=t.path.match(/(\d+)\.html$/))||void 0===n?void 0:n[1])||"0",10)-parseInt((null===(r=e.path.match(/(\d+)\.html$/))||void 0===r?void 0:r[1])||"0",10)})),[2,d.map((function(e,n){return t(t({},e),{chapterNumber:n+1})}))]):[2,[]]}}))}))},c.prototype.parseChapter=function(t){return e(this,void 0,void 0,(function(){var e,a,i,o,c,u,h;return n(this,(function(n){switch(n.label){case 0:if(!t||!t.includes("/")||t.endsWith("/"))throw new Error('[Quanben] Invalid chapterPath format received in parseChapter: "'.concat(t,'". Expected format: "novel-name/chapterFileName.html"'));return e="".concat(this.site,"n/").concat(t),[4,(0,r.fetchApi)(e)];case 1:if((a=n.sent()).ok)return[3,5];if(!(a.status>=300&&a.status<400))return[3,4];if(!(i=a.headers.get("Location")))return[3,4];if(!(o=s(i,e)))throw new Error("[Quanben] Failed to make redirected URL absolute: ".concat(i));return[4,(0,r.fetchApi)(o)];case 2:if(!(c=n.sent()).ok)throw new Error("[Quanben] Failed to fetch redirected chapter content: ".concat(o," - Status: ").concat(c.status));return u=this.extractChapterContent,[4,c.text()];case 3:return[2,u.apply(this,[n.sent(),o])];case 4:throw new Error("[Quanben] Failed to fetch chapter content: ".concat(e," - Status: ").concat(a.status));case 5:return[4,a.text()];case 6:return h=n.sent(),[2,this.extractChapterContent(h,e)]}}))}))},c.prototype.extractChapterContent=function(t,e){var n=(0,i.load)(t),r=n("#contentbody");if(r.length||(r=n("#content")),r.length||(r=n(".content")),!r.length)return"Error: Could not find chapter content container.";r.find('script, style, ins, iframe, [class*="ads"], [id*="ads"], [class*="google"], [id*="google"], [class*="recommend"], div[align="center"]').remove(),r.find("p").each((function(t,e){var r,a=n(e),i=a.text().trim();(i.includes("请记住本书首发域名")||i.includes("手机版阅读网址")||i.includes("quanben")||i.includes("最新网址")||i.includes("章节报错")||i.match(/app|APP|下载|客户端/)||0===i.length||""===(null===(r=a.html())||void 0===r?void 0:r.replace(/&nbsp;/g,"").trim())&&0===a.find("img").length)&&a.remove()})),r.contents().filter((function(){return"comment"===this.type})).remove();var a=r.html();return a?(a=(a=(a=a.replace(/<\s*p[^>]*>/gi,"\n\n")).replace(/<\s*br[^>]*>/gi,"\n")).replace(/<[^>]+>/g,""),a=(a=(a=(a=(0,i.load)("<div>".concat(a,"</div>")).text()).replace(/[\t ]+/g," ")).replace(/\n{3,}/g,"\n\n")).trim()):"Error: Chapter content was empty after cleaning."},c.prototype.searchNovels=function(t,a){return e(this,void 0,void 0,(function(){var e,a,o,c,u,h=this;return n(this,(function(n){switch(n.label){case 0:return e="".concat(this.site,"index.php?c=book&a=search&keywords=").concat(encodeURIComponent(t)),[4,(0,r.fetchApi)(e)];case 1:return(a=n.sent()).ok?[4,a.text()]:[2,[]];case 2:return o=n.sent(),c=(0,i.load)(o),u=[],c("div.list2").each((function(t,e){var n=c(e),r=n.find("h3 > a").first(),a=n.find("img").first(),i=r.text().trim(),o=r.attr("href"),l=a.attr("src")||a.attr("data-src");if(o&&i){var p=function(t){if(t)try{var e=new URL(t).pathname.match(/^(\/amp)?(\/n\/[^\/]+\/)/);return null==e?void 0:e[2]}catch(t){return}}(s(o,h.site));if(p){var f="/amp"+p,d=s(l,h.site);u.push({name:i,path:f,cover:d||h.defaultCover})}}})),[2,u]}}))}))},c.prototype.fetchImage=function(t){return e(this,void 0,void 0,(function(){return n(this,(function(e){return[2,(0,r.fetchApi)(t)]}))}))},c}();exports.default=new c;