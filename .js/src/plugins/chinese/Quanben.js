var t=this&&this.__assign||function(){return t=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},t.apply(this,arguments)},e=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(a,i){function o(t){try{s(r.next(t))}catch(t){i(t)}}function l(t){try{s(r.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,l)}s((r=r.apply(t,e||[])).next())}))},n=this&&this.__generator||function(t,e){var n,r,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=l(0),o.throw=l(1),o.return=l(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(i=0)),i;)try{if(n=1,r&&(a=2&l[0]?r.return:l[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,l[1])).done)return a;switch(r=0,a&&(l=[2&l[0],a.value]),l[0]){case 0:case 1:a=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,r=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==l[0]&&2!==l[0])){i=0;continue}if(3===l[0]&&(!a||l[1]>a[0]&&l[1]<a[3])){i.label=l[1];break}if(6===l[0]&&i.label<a[1]){i.label=a[1],a=l;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(l);break}a[2]&&i.ops.pop(),i.trys.pop();continue}l=e.call(t,i)}catch(t){l=[6,t],r=0}finally{n=a=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("@libs/filterInputs"),a=require("@libs/fetch"),i=require("@libs/novelStatus"),o=require("cheerio"),l=require("@libs/defaultCover"),s=function(t){if(t)try{return new URL(t,"https://www.quanben.io")}catch(t){return}},u=function(t){var e=s(t);if(e){var n=e.pathname.match(/^(\/amp)?(\/n\/[^\/]+\/)/);return null==n?void 0:n[2]}},c=function(t,e){if(t&&e)try{return t.startsWith("//")?"https:"+t:/^https?:\/\//.test(t)?t:new URL(t,e).href}catch(t){return}},h=function(){function h(){this.id="quanben",this.name="Quanben",this.site="https://www.quanben.io/",this.version="1.0.1",this.icon="src/cn/quanben/icon.png",this.defaultCover=l.defaultCover,this.filters={genre:{label:"分类",value:"all",options:[{label:"全部",value:"all"},{label:"玄幻",value:"xuanhuan"},{label:"都市",value:"dushi"},{label:"言情",value:"yanqing"},{label:"穿越",value:"chuanyue"},{label:"青春",value:"qingchun"},{label:"仙侠",value:"xianxia"},{label:"灵异",value:"lingyi"},{label:"悬疑",value:"xuanyi"},{label:"历史",value:"lishi"},{label:"军事",value:"junshi"},{label:"游戏",value:"youxi"},{label:"竞技",value:"jingji"},{label:"科幻",value:"kehuan"},{label:"职场",value:"zhichang"},{label:"官场",value:"guanchang"},{label:"现言",value:"xianyan"},{label:"耽美",value:"danmei"},{label:"其它",value:"qita"}],type:r.FilterTypes.Picker}}}return h.prototype.popularNovels=function(t,r){return e(this,arguments,void 0,(function(t,e){var r,i,l,s,h,f=this,p=e.filters;return n(this,(function(t){switch(t.label){case 0:return r="all"===p.genre.value?this.site:"".concat(this.site,"c/").concat(p.genre.value,".html"),[4,(0,a.fetchApi)(r)];case 1:if(!(i=t.sent()).ok)throw new Error("[Quanben] Failed to fetch: ".concat(r," - ").concat(i.status));return s=o.load,[4,i.text()];case 2:return l=s.apply(void 0,[t.sent()]),h=[],l("div.list2").each((function(t,e){var n,r,a,i=l(e),o=i.find("h3 > a").first(),s=null===(n=o.attr("href"))||void 0===n?void 0:n.trim(),p=o.text().trim(),v=(null===(r=i.find("img").attr("src"))||void 0===r?void 0:r.trim())||(null===(a=i.find("img").attr("data-src"))||void 0===a?void 0:a.trim()),d=c(v,f.site)||f.defaultCover;if(s&&p){var b=u(s);b&&h.push({name:p,path:b,cover:d})}})),l("ul.list").each((function(t,e){var n,r=l(e).find("li").first(),a=r.find("a").first(),i=null===(n=a.attr("href"))||void 0===n?void 0:n.trim(),o=a.text().trim()||r.find("span.author").text().trim(),s=f.defaultCover;if(i&&o){var c=u(i);c&&h.push({name:o,path:c,cover:s})}})),[2,h]}}))}))},h.prototype.parseNovel=function(t){return e(this,void 0,void 0,(function(){var e,r,l,s,u,h,f,p,v;return n(this,(function(n){switch(n.label){case 0:if(!(e=t.replace(/^\/amp/,"")).startsWith("/n/")||!e.endsWith("/"))throw new Error("[Quanben parseNovel] Invalid path: ".concat(t));if(!(r=c(e,this.site)))throw new Error("[Quanben parseNovel] Could not construct full URL");return[4,(0,a.fetchApi)(r)];case 1:if(!(l=n.sent()).ok)throw new Error("[Quanben parseNovel] Failed to fetch: ".concat(r));return u=o.load,[4,l.text()];case 2:return s=u.apply(void 0,[n.sent()]),h=s("div.list2").first(),f=s("div.description").first(),v={path:e,name:h.find("h3").text().trim()||"Unknown Novel",cover:c(h.find("img").attr("src"),this.site)||this.defaultCover,summary:f.find("p").text().trim()||f.text().trim()||void 0,author:h.find("p:contains('作者:') span").text().trim()||void 0,status:i.NovelStatus.Unknown,genres:h.find("p:contains('类别:') span").text().trim()||void 0},[4,this.parseChapterList(e)];case 3:return v.chapters=n.sent(),(p=v).status=i.NovelStatus.Completed,[2,p]}}))}))},h.prototype.parseChapterList=function(r){return e(this,void 0,void 0,(function(){var e,i,l,u,h,f,p,v,d=this;return n(this,(function(n){switch(n.label){case 0:return r.startsWith("/n/")&&r.endsWith("/")&&(e=c(r+"list.html",this.site))?[4,(0,a.fetchApi)(e)]:[2,[]];case 1:return(i=n.sent()).ok?(u=o.load,[4,i.text()]):[2,[]];case 2:return l=u.apply(void 0,[n.sent()]),h=[],(f=null===(v=r.match(/\/n\/([^\/]+)\//))||void 0===v?void 0:v[1])?(l("ul.list3 li a").each((function(t,e){var n=l(e),r=n.text().trim(),a=n.attr("href");if(r&&a){var i=function(t){var e=s(t);if(e){var n=e.pathname.split("/").pop();return n&&/^\d+\.html$/.test(n)?n:void 0}}(c(a,d.site));i&&h.push({name:r,path:"".concat(f,"/").concat(i)})}})),(p=Array.from(new Map(h.map((function(t){return[t.path,t]}))).values())).sort((function(t,e){var n,r;return parseInt((null===(n=t.path.match(/(\d+)\.html$/))||void 0===n?void 0:n[1])||"0",10)-parseInt((null===(r=e.path.match(/(\d+)\.html$/))||void 0===r?void 0:r[1])||"0",10)})),[2,p.map((function(e,n){return t(t({},e),{chapterNumber:n+1})}))]):[2,[]]}}))}))},h.prototype.parseChapter=function(t){return e(this,void 0,void 0,(function(){var e,r,i;return n(this,(function(n){switch(n.label){case 0:if(!t.includes("/")||t.endsWith("/"))throw new Error('[Quanben] Invalid chapter path: "'.concat(t,'"'));return e="".concat(this.site,"n/").concat(t),[4,(0,a.fetchApi)(e)];case 1:if(!(r=n.sent()).ok)throw new Error("[Quanben] Failed to fetch chapter: ".concat(e));return i=this.extractChapterContent,[4,r.text()];case 2:return[2,i.apply(this,[n.sent()])]}}))}))},h.prototype.extractChapterContent=function(t){var e=(0,o.load)(t)("#contentbody, #content, .content").first();return e.length?(e.find('script, style, ins, iframe, [class*="ads"], [id*="ads"], [class*="google"], [id*="google"], [class*="recommend"], div[align="center"]').remove(),(e.html()||"").replace(/[\t ]+/g," ").trim()||"Error: Chapter content empty."):"Error: Chapter content not found."},h.prototype.searchNovels=function(t){return e(this,void 0,void 0,(function(){var e,r,i,l,s,h=this;return n(this,(function(n){switch(n.label){case 0:return e="".concat(this.site,"index.php?c=book&a=search&keywords=").concat(encodeURIComponent(t)),[4,(0,a.fetchApi)(e)];case 1:return(r=n.sent()).ok?(l=o.load,[4,r.text()]):[2,[]];case 2:return i=l.apply(void 0,[n.sent()]),s=[],i("div.list2").each((function(t,e){var n=i(e),r=n.find("h3 > a").first(),a=r.attr("href"),o=r.text().trim(),l=c(n.find("img").attr("src")||n.find("img").attr("data-src"),h.site);if(a&&o){var f=u(c(a,h.site));f&&s.push({name:o,path:"/amp"+f,cover:l||h.defaultCover})}})),[2,s]}}))}))},h.prototype.fetchImage=function(t){return e(this,void 0,void 0,(function(){return n(this,(function(e){return[2,(0,a.fetchApi)(t)]}))}))},h}();exports.default=new h;