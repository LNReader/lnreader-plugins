var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(i,o){function a(t){try{s(n.next(t))}catch(t){o(t)}}function c(t){try{s(n.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,c)}s((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=c(0),a.throw=c(1),a.return=c(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(s){return function(c){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(o=0)),o;)try{if(r=1,n&&(i=2&c[0]?n.return:c[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,c[1])).done)return i;switch(n=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,n=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=e.call(t,o)}catch(t){c=[6,t],n=0}finally{r=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("cheerio"),n=require("@libs/fetch"),i=require("@libs/defaultCover"),o=require("@libs/novelStatus"),a=function(t,e){if(t)try{return t.startsWith("//")?new URL(e).protocol+t:t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(t){return}},c=function(){function c(){this.id="ixdzs8",this.name="爱下电子书",this.site="https://ixdzs8.com/",this.version="2.2.8",this.icon="src/cn/ixdzs8/favicon.png",this.imageRequestInit={headers:{Referer:this.site}}}return c.prototype.popularNovels=function(o){return t(this,void 0,void 0,(function(){var t,c,s,l,u,h,f=this;return e(this,(function(e){switch(e.label){case 0:return t="".concat(this.site,"hot/?page=").concat(o),[4,(0,n.fetchApi)(t)];case 1:return(c=e.sent()).ok?(l=r.load,[4,c.text()]):[2,[]];case 2:return s=l.apply(void 0,[e.sent()]),u=[],h=new Set,s("ul.u-list > li.burl").each((function(t,e){var r,n,o,c,l,p=s(e),d=p.find(".l-info h3 a");o=null===(r=d.attr("href"))||void 0===r?void 0:r.trim(),c=(d.attr("title")||d.text()||"").trim(),l=null===(n=p.find(".l-img img").attr("src"))||void 0===n?void 0:n.trim(),o&&c&&(u.push({name:c,path:o,cover:a(l,f.site)||i.defaultCover}),h.add(o))})),[2,u]}}))}))},c.prototype.parseNovel=function(c){return t(this,void 0,void 0,(function(){var t,s,l,u,h,f,p,d,v,m,g,w,b,y,x;return e(this,(function(e){switch(e.label){case 0:if(!(t=a(c,this.site)))throw new Error("Invalid novel URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(s=e.sent()).ok)throw new Error("Failed to fetch novel");return u=r.load,[4,s.text()];case 2:return l=u.apply(void 0,[e.sent()]),h=l("div.novel"),(f=l("p#intro.pintro")).find("span.icon").remove(),p=null===(x=f.html())||void 0===x?void 0:x.replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"").replace(/\u3000/g," ").replace(/&nbsp;/g," ").split("\n").map((function(t){return t.trim()})).filter((function(t){return t.length>0})).join(" "),d=l("div.panel div.tags"),v=h.find(".n-text p span.lz").text().trim(),m=h.find(".n-text p span.end").text().trim(),g="Unknown",g=m.length>0?"Completed":v.length>0?"Ongoing":"Unknown",w={path:c,name:h.find(".n-text h1").text().trim()||"Untitled",cover:a(h.find(".n-img img").attr("src"),this.site)||i.defaultCover,summary:p,author:h.find(".n-text p a.bauthor").text().trim()||void 0,genres:d.find("em a").map((function(t,e){return l(e).text().trim()})).get().filter((function(t){return t.length>0})).join(", "),status:"Ongoing"===g?o.NovelStatus.Ongoing:"Completed"===g?o.NovelStatus.Completed:o.NovelStatus.Unknown,chapters:[]},(b=l("#bid").attr("value"))?(y=w,[4,this.parseChapterList(b)]):[3,4];case 3:y.chapters=e.sent(),e.label=4;case 4:return[2,w]}}))}))},c.prototype.parseChapterList=function(r){return t(this,void 0,void 0,(function(){var t,n,i,o;return e(this,(function(e){switch(e.label){case 0:return t=String(r),n="".concat(this.site,"novel/clist/"),[4,fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"bid=".concat(t)})];case 1:if(!(i=e.sent()).ok)throw new Error("Failed to fetch chapters for bid=".concat(t));return[4,i.json()];case 2:if(200!==(o=e.sent()).rs||!Array.isArray(o.data))throw new Error("Invalid response format from chapter list");return[2,o.data.map((function(e){return{name:e.title,path:"0"===e.ctype?"read/".concat(t,"/p").concat(e.ordernum,".html"):"",releaseTime:void 0}}))]}}))}))},c.prototype.parseChapter=function(i){return t(this,void 0,void 0,(function(){var t,o,c,s,l,u,h,f;return e(this,(function(e){switch(e.label){case 0:if(!(t=a(i,this.site)))throw new Error("Invalid chapter URL");return[4,(0,n.fetchApi)(t)];case 1:if(!(o=e.sent()).ok)throw new Error("Failed to fetch chapter at ".concat(t));return[4,o.text()];case 2:return((c=e.sent()).includes("正在進行安全驗證")||c.includes("challenge"))&&(s=c.match(/let token\s*=\s*"([^"]+)"/))?(l=t+"?challenge="+encodeURIComponent(s[1]),[4,(0,n.fetchApi)(l)]):[3,5];case 3:if(!(o=e.sent()).ok)throw new Error("Failed after challenge redirect: ".concat(l));return[4,o.text()];case 4:c=e.sent(),e.label=5;case 5:return u=(0,r.load)(c),(h=u("article section")).length?(h.find('script, style, ins, iframe, [class*="abg"], [class*="ads"], [id*="ads"], [class*="google"], [id*="google"], [class*="recommend"], div[align="center"], p:contains("推薦本書"), a[href*="javascript:"]').remove(),h.find("p").each((function(t,e){var r=u(e);r.text().trim()||r.remove()})),h.contents().filter((function(){return"comment"===this.type})).remove(),h.find("font").each((function(t,e){var r=u(e);r.replaceWith(r.html()||"")})),(f=h.html())?(f=f.replace(/<\s*p[^>]*>/gi,"\n\n").replace(/<\s*br[^>]*>/gi,"\n"),[2,(f=(0,r.load)("<div>".concat(f,"</div>")).text()).replace(/[\t ]+/g," ").replace(/\n{3,}/g,"\n\n").trim()]):[2,"Error: Chapter content was empty"]):[2,"Error: Could not find chapter content at ".concat(t)]}}))}))},c.prototype.searchNovels=function(o,c){return t(this,void 0,void 0,(function(){var t,c,s,l,u,h,f=this;return e(this,(function(e){switch(e.label){case 0:t="".concat(this.site,"bsearch?q=").concat(encodeURIComponent(o)),c="",e.label=1;case 1:return e.trys.push([1,4,,5]),[4,(0,n.fetchApi)(t)];case 2:if(!(s=e.sent()).ok)throw new Error("Failed to fetch search results: HTTP ".concat(s.status));return[4,s.text()];case 3:return c=e.sent(),[3,5];case 4:if((l=e.sent())instanceof Error)throw new Error("Failed to fetch search results: ".concat(l.message));throw l;case 5:return u=(0,r.load)(c),h=[],u("ul.u-list li.burl").each((function(t,e){var r,n,o=u(e),c=null===(r=o.attr("data-url"))||void 0===r?void 0:r.trim(),s=o.find("h3.bname a").text().trim(),l=null===(n=o.find(".l-img img").attr("src"))||void 0===n?void 0:n.trim();c&&s&&h.push({name:s,path:c,cover:a(l,f.site)||i.defaultCover})})),[2,h]}}))}))},c}();exports.default=new c;