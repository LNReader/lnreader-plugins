var t=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))((function(n,o){function a(t){try{c(i.next(t))}catch(t){o(t)}}function s(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}c((i=i.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,i,n,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(o=0)),o;)try{if(r=1,i&&(n=2&s[0]?i.return:s[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,s[1])).done)return n;switch(i=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){o.label=s[1];break}if(6===s[0]&&o.label<n[1]){o.label=n[1],n=s;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(s);break}n[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],i=0}finally{r=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("cheerio"),i=require("@libs/fetch"),n=require("@libs/defaultCover"),o=require("@libs/novelStatus"),a=function(t,e){if(t)try{return t.startsWith("//")?new URL(e).protocol+t:t.startsWith("http://")||t.startsWith("https://")?t:new URL(t,e).href}catch(t){return}},s=function(){function s(){this.id="novel543",this.name="Novel543",this.site="https://www.novel543.com/",this.version="1.0.0",this.icon="src/cn/novel543/icon.png",this.imageRequestInit={headers:{Referer:this.site}}}return s.prototype.popularNovels=function(o){return t(this,void 0,void 0,(function(){var t,s,c,l,u,h=this;return e(this,(function(e){switch(e.label){case 0:return o>1?[2,[]]:[4,(0,i.fetchApi)(this.site)];case 1:return(t=e.sent()).ok?(c=r.load,[4,t.text()]):[2,[]];case 2:return s=c.apply(void 0,[e.sent()]),l=[],u=new Set,s('ul.list > li.media, ul.list li > a[href^="/"][href$="/"]').each((function(t,e){var r,i,o,c,d,f,p,v,m=s(e);if(m.is("li.media")){var w=m.find(".media-content h3 a");f=null===(r=w.attr("href"))||void 0===r?void 0:r.trim(),p=w.text().trim(),v=null===(i=m.find(".media-left img").attr("src"))||void 0===i?void 0:i.trim()}else m.is("a")&&(f=null===(o=m.attr("href"))||void 0===o?void 0:o.trim(),p=m.find("h3, b, span").first().text().trim()||m.parent().find("h3").text().trim()||m.text().trim(),v=(null===(c=m.find("img").attr("src"))||void 0===c?void 0:c.trim())||(null===(d=m.parent().find("img").attr("src"))||void 0===d?void 0:d.trim()));f&&p&&f.match(/^\/\d+\/$/)&&!u.has(f)&&(l.push({name:p,path:f,cover:a(v,h.site)||n.defaultCover}),u.add(f))})),[2,l]}}))}))},s.prototype.parseNovel=function(s){return t(this,void 0,void 0,(function(){var t,c,l,u,h,d,f,p,v;return e(this,(function(e){switch(e.label){case 0:if(!(t=a(s,this.site)))throw new Error("Invalid novel URL");return[4,(0,i.fetchApi)(t)];case 1:if(!(c=e.sent()).ok)throw new Error("Failed to fetch novel");return u=r.load,[4,c.text()];case 2:return l=u.apply(void 0,[e.sent()]),h=l("section#detail div.media-content.info"),d=l("section#detail div.mod"),f={path:s,name:h.find("h1.title").text().trim()||"Untitled",cover:a(l("section#detail div.cover img").attr("src"),this.site)||n.defaultCover,summary:d.find("div.intro").text().trim()||void 0,author:h.find("p.meta span.author").text().trim()||void 0,genres:h.find('p.meta a[href*="/bookstack/"]').map((function(t,e){return l(e).text().trim()})).get().join(", ")||void 0,status:o.NovelStatus.Unknown,chapters:[]},(p=d.find('p.action.buttons a.button.is-info[href$="/dir"]').attr("href")||h.find('a.button.is-info[href$="/dir"]').attr("href"))?(v=f,[4,this.parseChapterList(p)]):[3,4];case 3:v.chapters=e.sent(),e.label=4;case 4:return[2,f]}}))}))},s.prototype.parseChapterList=function(n){return t(this,void 0,void 0,(function(){var t,o,s,c,l;return e(this,(function(e){switch(e.label){case 0:return(t=a(n,this.site))?[4,(0,i.fetchApi)(t)]:[2,[]];case 1:return(o=e.sent()).ok?(c=r.load,[4,o.text()]):[2,[]];case 2:return s=c.apply(void 0,[e.sent()]),l=[],s("div.chaplist ul.all li a").each((function(t,e){var r,i=s(e),n=i.text().trim(),o=null===(r=i.attr("href"))||void 0===r?void 0:r.trim();n&&o&&l.push({name:n,path:o,chapterNumber:t+1})})),"倒序"===s("div.chaplist .header button.reverse span").last().text().trim()&&(l.reverse(),l.forEach((function(t,e){return t.chapterNumber=e+1}))),[2,l]}}))}))},s.prototype.parseChapter=function(n){return t(this,void 0,void 0,(function(){var t,o,s,c,l,u;return e(this,(function(e){switch(e.label){case 0:if(!(t=a(n,this.site)))throw new Error("Invalid chapter URL");return[4,(0,i.fetchApi)(t)];case 1:if(!(o=e.sent()).ok)throw new Error("Failed to fetch chapter");return c=r.load,[4,o.text()];case 2:return s=c.apply(void 0,[e.sent()]),(l=s("div.content.py-5")).length?(l.find('script, style, ins, iframe, [class*="ads"], [id*="ads"], [class*="google"], [id*="google"], [class*="recommend"], div[align="center"], p:contains("推薦本書"), a[href*="javascript:"]').remove(),l.find("p").each((function(t,e){var r,i=s(e),n=i.text().trim();(n.includes("請記住本站域名")||n.includes("手機版閱讀網址")||n.includes("novel543")||n.includes("稷下書院")||n.includes("最快更新")||n.includes("最新章節")||n.includes("章節報錯")||n.match(/app|APP|下載|客户端|关注微信|公众号/i)||0===n.length||""===(null===(r=i.html())||void 0===r?void 0:r.replace(/&nbsp;/g,"").trim())&&0===i.find("img").length||n.includes("溫馨提示"))&&i.remove()})),l.contents().filter((function(){return"comment"===this.type})).remove(),(u=l.html())?(u=u.replace(/<\s*p[^>]*>/gi,"\n\n").replace(/<\s*br[^>]*>/gi,"\n"),[2,(u=(0,r.load)("<div>".concat(u,"</div>")).text()).replace(/[\t ]+/g," ").replace(/\n{3,}/g,"\n\n").trim()]):[2,"Error: Chapter content was empty"]):[2,"Error: Could not find chapter content"]}}))}))},s.prototype.searchNovels=function(o,s){return t(this,void 0,void 0,(function(){var t,c,l,u,h,d,f,p,v,m,w=this;return e(this,(function(e){switch(e.label){case 0:if(s>1)return[2,[]];if(!/^\d+$/.test(o))return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),t="/".concat(o,"/"),[4,this.parseNovel(t)];case 2:return[2,[{name:(c=e.sent()).name,path:t,cover:c.cover}]];case 3:return e.sent(),[2,[]];case 4:l="".concat(this.site,"search/").concat(encodeURIComponent(o)),u="",e.label=5;case 5:return e.trys.push([5,8,,9]),[4,(0,i.fetchApi)(l)];case 6:if(!(h=e.sent()).ok){if(403===h.status||503===h.status)throw new Error("Cloudflare protection detected (HTTP error). Please try opening the plugin in WebView first to solve the challenge.");return[2,[]]}return[4,h.text()];case 7:if(u=e.sent(),d=(0,r.load)(u),(f=d("title").text().toLowerCase()).includes("attention required")||f.includes("just a moment")||f.includes("please wait")||f.includes("verifying")||u.includes("Verifying you are human")||u.includes("cf-browser-verification")||u.includes("cf_captcha_container"))throw new Error("Cloudflare protection detected. Please try opening the plugin in WebView first to solve the challenge.");return[3,9];case 8:if((p=e.sent())instanceof Error){if(p.message.includes("Cloudflare protection detected"))throw p;throw new Error("Failed to fetch search results: ".concat(p.message))}throw p;case 9:return v=(0,r.load)(u),m=[],v("div.search-list ul.list > li.media").each((function(t,e){var r,i,o=v(e),s=o.find(".media-content h3 a"),c=null===(r=s.attr("href"))||void 0===r?void 0:r.trim(),l=s.text().trim(),u=null===(i=o.find(".media-left img").attr("src"))||void 0===i?void 0:i.trim();c&&l&&c.match(/^\/\d+\/$/)&&m.push({name:l,path:c,cover:a(u,w.site)||n.defaultCover})})),[2,m]}}))}))},s}();exports.default=new s;