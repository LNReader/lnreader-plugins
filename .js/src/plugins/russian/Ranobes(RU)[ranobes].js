var e=this&&this.__assign||function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},e.apply(this,arguments)},t=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(s,a){function i(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,o)}c((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var r,n,s,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=o(0),i.throw=o(1),i.return=o(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(a=0)),a;)try{if(r=1,n&&(s=2&o[0]?n.return:o[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,o[1])).done)return s;switch(n=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(s=a.trys,(s=s.length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){a.label=o[1];break}if(6===o[0]&&a.label<s[1]){a.label=s[1],s=o;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(o);break}s[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{r=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var n=require("htmlparser2"),s=require("@libs/fetch"),a=require("@libs/novelStatus"),i=new(function(){function i(e){var t=this;this.parseDate=function(e){var r=new Date;if(!e)return r.toISOString();if("ranobes-ru"===t.id){if(e.includes(" в "))return e.replace(" в "," г., ");var n=e.split(", "),s=n[0],a=n[1];if(!a)return r.toISOString();var i=a.split(":"),o=i[0],c=i[1];switch(s){case"Сегодня":r.setHours(parseInt(o,10)),r.setMinutes(parseInt(c,10));break;case"Вчера":r.setDate(r.getDate()-1),r.setHours(parseInt(o,10)),r.setMinutes(parseInt(c,10));break;default:return r.toISOString()}}else{var u=e.split(" "),l=u[0],h=u[1];if("ago"!==u[2])return r.toISOString();switch(h){case"minutes":r.setMinutes(parseInt(l,10));break;case"hour":case"hours":r.setHours(parseInt(l,10));break;case"day":case"days":r.setDate(r.getDate()-parseInt(l,10));break;case"month":case"months":r.setMonth(r.getMonth()-parseInt(l,10));break;case"year":case"years":r.setFullYear(r.getFullYear()-parseInt(l,10));break;default:return r.toISOString()}}return r.toISOString()},this.id=e.id,this.name=e.sourceName,this.icon="multisrc/ranobes/ranobes/icon.png",this.site=e.sourceSite,this.version="2.0.2",this.options=e.options}return i.prototype.safeFecth=function(e){return t(this,arguments,void 0,(function(e,t){var n,a,i,o,c;return void 0===t&&(t={}),r(this,(function(r){switch(r.label){case 0:return[4,(0,s.fetchApi)(e,t)];case 1:if(!(n=r.sent()).ok)throw new Error("Could not reach site ("+n.status+") try to open in webview.");return[4,n.text()];case 2:if(a=r.sent(),(i=null===(c=null===(o=a.match(/<title>(.*?)<\/title>/))||void 0===o?void 0:o[1])||void 0===c?void 0:c.trim())&&("Bot Verification"==i||"You are being redirected..."==i||"Un instant..."==i||"Just a moment..."==i||"Redirecting..."==i))throw new Error("Captcha error, please open in webview");return[2,a]}}))}))},i.prototype.parseNovels=function(e){var t=[],r={name:""},s=this.site,a=!1,i=!1,o=!1,c=new n.Parser({onopentag:function(e,n){var c,u;(null===(c=n.class)||void 0===c?void 0:c.includes("short-cont"))&&(a=!0),a&&("h2"===e&&(null===(u=n.class)||void 0===u?void 0:u.includes("title"))&&(i=!0),i&&"a"===e&&(r.path=n.href.slice(s.length),o=!0),"figure"===e&&(r.cover=n.style.replace(/.*url\((.*?)\)./g,"$1")),r.path&&r.cover&&(t.push(r),(r={}).name=""))},ontext:function(e){o&&(r.name+=e)},onclosetag:function(e){"h2"===e&&(o=!1,i=!1),"figure"===e&&(a=!1)}});return c.write(e),c.end(),t},i.prototype.parseChapters=function(e){var t=this,r=[];return e.chapters.map((function(e){r.push({name:e.title,releaseTime:new Date(e.date).toISOString(),path:e.link.slice(t.site.length)})})),r.reverse()},i.prototype.popularNovels=function(e){return t(this,void 0,void 0,(function(){var t,n;return r(this,(function(r){switch(r.label){case 0:return t="".concat(this.site,"/").concat(this.options.path,"/page/").concat(e,"/"),[4,this.safeFecth(t)];case 1:return n=r.sent(),[2,this.parseNovels(n)]}}))}))},i.prototype.parseNovel=function(s){return t(this,void 0,void 0,(function(){var t,i,o,c,u,l,h,p,f,d,v,g,m,b,w,y,S,O,_,I;return r(this,(function(r){switch(r.label){case 0:return t=this.site,[4,this.safeFecth(t+s)];case 1:return i=r.sent(),o={path:s,name:"",summary:"",chapters:[],totalPages:1},c=!1,u=!1,l=!1,h=!1,p=!1,f=!1,d=!1,v=!1,g=!1,m=!1,b=!1,w=[],y=[],S={},O=0,_=this.parseDate,(I=new n.Parser({onopentag:function(e,r){"poster"===r.class&&(c=!0),c&&"img"===e&&(o.name=r.alt,o.cover=t+r.src),("div"===e&&"moreless cont-text showcont-h"===r.class||"cont-text showcont-h"===r.class&&"description"===r.itemprop)&&(l=!0),"li"===e&&r.title&&(r.title.includes("Original status")||r.title.includes("Статус оригинала"))&&(h=!0),"a"===e&&"chapter"===r.rel&&(g=!0,S.path=r.href.replace(t,"")),g&&"span"===e&&"title ellipses"===r.class&&(m=!0),g&&"span"===e&&"grey"===r.class&&(b=!0),"li"!==e||"Glossary + illustrations + division of chapters, etc."!=r.title&&"Глоссарий + иллюстраций + разделение глав и т.д."!==r.title||(v=!0)},onopentagname:function(e){l&&"br"===e&&(o.summary+="\n"),h&&"a"===e&&(p=!0),f&&"a"===e&&(d=!0)},onattribute:function(e,t){"itemprop"===e&&"creator"===t&&(u=!0),"id"===e&&"mc-fs-genre"===t&&(f=!0)},ontext:function(e){if(u&&(o.author=e),l&&(o.summary+=e.trim()),p&&(o.status="Ongoing"===e||"В процессе"==e?a.NovelStatus.Ongoing:a.NovelStatus.Completed),d&&w.push(e),v){var t=e.replace(/\D/g,"");t&&(O=parseInt(t,10))}g&&(m&&(S.name=e.trim()),b&&(S.releaseTime=_(e.trim())))},onclosetag:function(t){"a"===t&&(c=!1,u=!1,p=!1,d=!1,h=!1),"div"===t&&(l=!1,f=!1),"li"===t&&(v=!1),"a"===t&&(g=!1,S.name&&(y.push(e(e({},S),{page:"1"})),S={})),"span"===t&&(m&&(m=!1),b&&(b=!1))}})).write(i),I.end(),o.genres=w.join(", "),o.totalPages=Math.ceil((O||1)/25),o.chapters=y,o.chapters[0].path&&(o.latestChapter=o.chapters[0]),[2,o]}}))}))},i.prototype.parsePage=function(e,s){return t(this,void 0,void 0,(function(){var t,a,i,o,c,u,l,h,p,f,d,v,g,m;return r(this,(function(r){switch(r.label){case 0:return t="ranobes"==this.id?e.split("-")[0]:"/"+e.split("-").slice(1).join("-").split(".")[0],a=this.site+"/chapters"+t.replace(this.options.path+"/",""),[4,this.safeFecth(a+"/page/"+s)];case 1:return i=r.sent(),o=this.site,c=!1,u=!1,l=!1,h=!1,p=[],f={},d=this.parseDate,v={pages_count:"",chapters:[]},(g=new n.Parser({onopentag:function(e,t){"div"===e&&"cat_block cat_line"===t.class&&(u=!0),u&&"a"===e&&t.title&&t.href&&(f.name=t.title,f.path=t.href.replace(o,"")),"span"===e&&"grey small"===t.class&&(l=!0),"small"===e&&l&&(h=!0)},ontext:function(e){h&&(f.releaseTime=d(e.trim())),c&&e.includes("window.__DATA__ =")&&(v=JSON.parse(e.replace("window.__DATA__ =","")))},onclosetag:function(e){"a"===e&&f.name&&(p.push(f),f={}),"div"===e&&(u=!1),"span"===e&&(l=!1),"small"===e&&(h=!1),"main"===e&&(c=!0),"script"===e&&(c=!1)}})).write(i),g.end(),(null===(m=v.chapters)||void 0===m?void 0:m.length)&&(p=this.parseChapters(v)),[2,{chapters:p}]}}))}))},i.prototype.parseChapter=function(e){return t(this,void 0,void 0,(function(){var t,n,s;return r(this,(function(r){switch(r.label){case 0:return[4,this.safeFecth(this.site+e)];case 1:return t=r.sent(),n=t.indexOf('<div class="text" id="arrticle">'),s=t.indexOf('<div class="category grey ellipses">',n),[2,t.substring(n,s)]}}))}))},i.prototype.searchNovels=function(e,n){return t(this,void 0,void 0,(function(){var t,s;return r(this,(function(r){switch(r.label){case 0:return"ranobes-ru"!==this.id?[3,2]:[4,this.safeFecth(this.site+"/index.php?do=search",{headers:{"Content-Type":"application/x-www-form-urlencoded",Referer:this.site+"/"},method:"POST",body:new URLSearchParams({do:"search",subaction:"search",search_start:n.toString(),story:e}).toString()})];case 1:return t=r.sent(),[3,4];case 2:return s="".concat(this.site,"/search/").concat(e,"/page/").concat(n),[4,this.safeFecth(s)];case 3:t=r.sent(),r.label=4;case 4:return[2,this.parseNovels(t)]}}))}))},i}())({id:"ranobes-ru",sourceSite:"https://ranobes.com",sourceName:"Ranobes (RU)",options:{lang:"Russian",path:"ranobe"}});exports.default=i;