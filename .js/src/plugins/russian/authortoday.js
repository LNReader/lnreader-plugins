var e=this&&this.__awaiter||function(e,a,t,l){return new(t||(t=Promise))((function(r,i){function n(e){try{u(l.next(e))}catch(e){i(e)}}function o(e){try{u(l.throw(e))}catch(e){i(e)}}function u(e){var a;e.done?r(e.value):(a=e.value,a instanceof t?a:new t((function(e){e(a)}))).then(n,o)}u((l=l.apply(e,a||[])).next())}))},a=this&&this.__generator||function(e,a){var t,l,r,i,n={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(u){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(n=0)),n;)try{if(t=1,l&&(r=2&o[0]?l.return:o[0]?l.throw||((r=l.return)&&r.call(l),0):l.next)&&!(r=r.call(l,o[1])).done)return r;switch(l=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,l=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if(!(r=n.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){n=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){n.label=o[1];break}if(6===o[0]&&n.label<r[1]){n.label=r[1],r=o;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(o);break}r[2]&&n.ops.pop(),n.trys.pop();continue}o=a.call(e,n)}catch(e){o=[6,e],l=0}finally{t=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var l=require("@libs/filterInputs"),r=require("@libs/defaultCover"),i=require("@libs/fetch"),n=require("@libs/novelStatus"),o=require("cheerio"),u=require("@libs/storage"),s=t(require("dayjs")),c=function(){function t(){var t=this;this.id="AT",this.name="Автор Тудей",this.icon="src/ru/authortoday/icon.png",this.site="https://author.today",this.apiSite="https://api.author.today/v1/",this.imageSite="https://cm.author.today/content/",this.version="1.1.1",this.resolveUrl=function(e,a){return t.site+(a?"/work/":"/reader/")+e},this.getUser=function(){return e(t,void 0,void 0,(function(){var e,t,l,r;return a(this,(function(a){switch(a.label){case 0:return(e=u.storage.get("user")||{userId:"",token:"guest"})&&e.userId&&e.token?[4,(0,i.fetchApi)(this.apiSite+"account/current-user",{headers:{Authorization:"Bearer "+e.token||"guest"}}).then((function(e){return e.json()}))]:[3,2];case 1:if((null==(t=a.sent())?void 0:t.id)&&!t.isDisabled)return[2,e];u.storage.delete("user"),e={userId:"",token:"guest"},a.label=2;case 2:return[4,(0,i.fetchApi)(this.site+"/account/bearer-token")];case 3:return(l=a.sent()).url.includes("Login?ReturnUrl=")?[2,e]:[4,l.json()];case 4:return r=a.sent(),e={userId:r.userId,token:r.token},u.storage.set("user",e,new Date(r.expires).getTime()-36e5),[2,e]}}))}))},this.filters={sort:{label:"Сортировка",value:"popular",options:[{label:"По популярности",value:"popular"},{label:"По количеству лайков",value:"likes"},{label:"По комментариям",value:"comments"},{label:"По новизне",value:"recent"},{label:"По просмотрам",value:"views"},{label:"Набирающие популярность",value:"trending"}],type:l.FilterTypes.Picker},genre:{label:"Жанры",value:"",options:[{label:"Все",value:""},{label:"Альтернативная история",value:"sf-history"},{label:"Антиутопия",value:"dystopia"},{label:"Бизнес-литература",value:"biznes-literatura"},{label:"Боевая фантастика",value:"sf-action"},{label:"Боевик",value:"action"},{label:"Боевое фэнтези",value:"fantasy-action"},{label:"Бояръ-Аниме",value:"boyar-anime"},{label:"Героическая фантастика",value:"sf-heroic"},{label:"Героическое фэнтези",value:"heroic-fantasy"},{label:"Городское фэнтези",value:"urban-fantasy"},{label:"Детектив",value:"detective"},{label:"Детская литература",value:"detskaya-literatura"},{label:"Документальная проза",value:"non-fiction"},{label:"Историческая проза",value:"historical-fiction"},{label:"Исторические приключения",value:"historical-adventure"},{label:"Исторический детектив",value:"historical-mystery"},{label:"Исторический любовный роман",value:"historical-romance"},{label:"Историческое фэнтези",value:"historical-fantasy"},{label:"Киберпанк",value:"cyberpunk"},{label:"Короткий любовный роман",value:"short-romance"},{label:"Космическая фантастика",value:"sf-space"},{label:"ЛитРПГ",value:"litrpg"},{label:"Любовное фэнтези",value:"love-fantasy"},{label:"Любовные романы",value:"romance"},{label:"Мистика",value:"paranormal"},{label:"Назад в СССР",value:"back-to-ussr"},{label:"Научная фантастика",value:"science-fiction"},{label:"Подростковая проза",value:"teen-prose"},{label:"Политический роман",value:"political-fiction"},{label:"Попаданцы",value:"popadantsy"},{label:"Попаданцы в космос",value:"popadantsy-v-kosmos"},{label:"Попаданцы в магические миры",value:"popadantsy-v-magicheskie-miry"},{label:"Попаданцы во времени",value:"popadantsy-vo-vremeni"},{label:"Постапокалипсис",value:"postapocalyptic"},{label:"Поэзия",value:"poetry"},{label:"Приключения",value:"adventure"},{label:"Публицистика",value:"publicism"},{label:"Развитие личности",value:"razvitie-lichnosti"},{label:"Разное",value:"other"},{label:"РеалРПГ",value:"realrpg"},{label:"Романтическая эротика",value:"romantic-erotika"},{label:"Сказка",value:"fairy-tale"},{label:"Современная проза",value:"modern-prose"},{label:"Современный любовный роман",value:"contemporary-romance"},{label:"Социальная фантастика",value:"sf-social"},{label:"Стимпанк",value:"steampunk"},{label:"Темное фэнтези",value:"dark-fantasy"},{label:"Триллер",value:"thriller"},{label:"Ужасы",value:"horror"},{label:"Фантастика",value:"sci-fi"},{label:"Фантастический детектив",value:"detective-science-fiction"},{label:"Фанфик",value:"fanfiction"},{label:"Фэнтези",value:"fantasy"},{label:"Шпионский детектив",value:"spy-mystery"},{label:"Эпическое фэнтези",value:"epic-fantasy"},{label:"Эротика",value:"erotica"},{label:"Эротическая фантастика",value:"sf-erotika"},{label:"Эротический фанфик",value:"fanfiction-erotika"},{label:"Эротическое фэнтези",value:"fantasy-erotika"},{label:"Юмор",value:"humor"},{label:"Юмористическая фантастика",value:"sf-humor"},{label:"Юмористическое фэнтези",value:"ironical-fantasy"}],type:l.FilterTypes.Picker},form:{label:"Форма произведения",value:"any",options:[{label:"Любой",value:"any"},{label:"Перевод",value:"translation"},{label:"Повесть",value:"tale"},{label:"Рассказ",value:"story"},{label:"Роман",value:"novel"},{label:"Сборник поэзии",value:"poetry"},{label:"Сборник рассказов",value:"story-book"}],type:l.FilterTypes.Picker},state:{label:"Статус произведения",value:"any",options:[{label:"Любой статус",value:"any"},{label:"В процессе",value:"in-progress"},{label:"Завершено",value:"finished"}],type:l.FilterTypes.Picker},series:{label:"Статус цикла",value:"any",options:[{label:"Не важно",value:"any"},{label:"Вне цикла",value:"out"},{label:"Цикл завершен",value:"finished"},{label:"Цикл не завершен",value:"unfinished"}],type:l.FilterTypes.Picker},access:{label:"Тип доступа",value:"any",options:[{label:"Любой",value:"any"},{label:"Платный",value:"paid"},{label:"Бесплатный",value:"free"}],type:l.FilterTypes.Picker},promo:{label:"Промо-фрагмент",value:"hide",options:[{label:"Скрывать",value:"hide"},{label:"Показывать",value:"show"}],type:l.FilterTypes.Picker}}}return t.prototype.popularNovels=function(t,l){return e(this,arguments,void 0,(function(e,t){var l,n,o,u,s,c,v,h,b,p,d,f=this,y=t.showLatestNovels,m=t.filters;return a(this,(function(a){switch(a.label){case 0:return l=this.apiSite+"catalog/search?page="+e,(null===(u=null==m?void 0:m.genre)||void 0===u?void 0:u.value)&&(l+="&genre="+m.genre.value),l+="&sorting="+(y?"recent":(null===(s=null==m?void 0:m.sort)||void 0===s?void 0:s.value)||"popular"),l+="&form="+((null===(c=null==m?void 0:m.form)||void 0===c?void 0:c.value)||"any"),l+="&state="+((null===(v=null==m?void 0:m.state)||void 0===v?void 0:v.value)||"any"),l+="&series="+((null===(h=null==m?void 0:m.series)||void 0===h?void 0:h.value)||"any"),l+="&access="+((null===(b=null==m?void 0:m.access)||void 0===b?void 0:b.value)||"any"),l+="&promo="+((null===(p=null==m?void 0:m.promo)||void 0===p?void 0:p.value)||"hide"),[4,(0,i.fetchApi)(l,{headers:{Authorization:"Bearer guest"}}).then((function(e){return e.json()}))];case 1:return n=a.sent(),o=[],"NotFound"===n.code?[2,o]:(null===(d=null==n?void 0:n.searchResults)||void 0===d||d.forEach((function(e){return o.push({name:e.title,cover:e.coverUrl?f.imageSite+e.coverUrl:r.defaultCover,path:e.id.toString()})})),[2,o])}}))}))},t.prototype.parseNovel=function(t){return e(this,void 0,void 0,(function(){var e,l,o,u,c,v,h,b;return a(this,(function(a){switch(a.label){case 0:return this.user?[3,2]:(e=this,[4,this.getUser()]);case 1:e.user=a.sent(),a.label=2;case 2:return[4,(0,i.fetchApi)(this.apiSite+"work/"+t+"/details",{headers:{Authorization:"Bearer "+(null===(v=this.user)||void 0===v?void 0:v.token)||"guest"}}).then((function(e){return e.json()}))];case 3:return l=a.sent(),o={path:t,name:l.title,cover:l.coverUrl?l.coverUrl.split("?")[0]:r.defaultCover,genres:null===(h=l.tags)||void 0===h?void 0:h.join(", "),summary:"",author:l.originalAuthor||l.authorFIO||l.coAuthorFIO||l.secondCoAuthorFIO||l.translator||"",status:l.isFinished?n.NovelStatus.Completed:n.NovelStatus.Ongoing},l.annotation&&(o.summary+=l.annotation+"\n"),l.authorNotes&&(o.summary+="Примечания автора:\n"+l.authorNotes),[4,(0,i.fetchApi)(this.apiSite+"work/"+t+"/content",{headers:{Authorization:"Bearer "+(null===(b=this.user)||void 0===b?void 0:b.token)||"guest"}}).then((function(e){return e.json()}))];case 4:return u=a.sent(),c=[],u.forEach((function(e,a){e.isAvailable&&!e.isDraft&&c.push({name:e.title||"Глава "+(a+1),path:t+"/"+e.id,releaseTime:(0,s.default)(e.publishTime||e.lastModificationTime).format("LLL"),chapterNumber:(e.sortOrder||a)+1})})),o.chapters=c,[2,o]}}))}))},t.prototype.parseChapter=function(t){return e(this,void 0,void 0,(function(){var e,l,r,n,o,u,s;return a(this,(function(a){switch(a.label){case 0:return e=t.split("/"),l=e[0],r=e[1],this.user?[3,2]:(n=this,[4,this.getUser()]);case 1:n.user=a.sent(),a.label=2;case 2:return[4,(0,i.fetchApi)(this.apiSite+"work/".concat(l,"/chapter/").concat(r,"/text"),{headers:{Authorization:"Bearer "+(null===(u=this.user)||void 0===u?void 0:u.token)||"guest"}}).then((function(e){return e.json()}))];case 3:return(o=a.sent()).code?[2,o.code+"\n"+(null==o?void 0:o.message)]:[2,function(e,a,t){void 0===t&&(t="");for(var l=(a.split("").reverse().join("")+"@_@"+t).split("").map((function(e){return e.charCodeAt()})),r=l.length,i="",n=0;n<e.length;n++)i+=String.fromCharCode(e.charCodeAt(n)^l[n%r]);return i}(o.text,o.key,null===(s=this.user)||void 0===s?void 0:s.userId)]}}))}))},t.prototype.searchNovels=function(t){return e(this,arguments,void 0,(function(e,t){var l,n,u,s;return void 0===t&&(t=1),a(this,(function(a){switch(a.label){case 0:return l=this.site+"/search?category=works&q="+e+"&page="+t,[4,(0,i.fetchApi)(l).then((function(e){return e.text()}))];case 1:return n=a.sent(),u=(0,o.load)(n),s=[],u("a.work-row").each((function(e,a){var t=u(a).find('h4[class="work-title"]').text().trim(),l=u(a).find("img").attr("data-src"),i=u(a).attr("href");l=l?l.split("?")[0]:r.defaultCover,i&&s.push({name:t,cover:l,path:i.replace("/work/","")})})),[2,s]}}))}))},t}();exports.default=new c;