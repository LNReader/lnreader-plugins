var e=this&&this.__awaiter||function(e,l,a,t){return new(a||(a=Promise))((function(r,i){function n(e){try{u(t.next(e))}catch(e){i(e)}}function o(e){try{u(t.throw(e))}catch(e){i(e)}}function u(e){var l;e.done?r(e.value):(l=e.value,l instanceof a?l:new a((function(e){e(l)}))).then(n,o)}u((t=t.apply(e,l||[])).next())}))},l=this&&this.__generator||function(e,l){var a,t,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},n=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return n.next=o(0),n.throw=o(1),n.return=o(2),"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(o){return function(u){return function(o){if(a)throw new TypeError("Generator is already executing.");for(;n&&(n=0,o[0]&&(i=0)),i;)try{if(a=1,t&&(r=2&o[0]?t.return:o[0]?t.throw||((r=t.return)&&r.call(t),0):t.next)&&!(r=r.call(t,o[1])).done)return r;switch(t=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,t=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){i.label=o[1];break}if(6===o[0]&&i.label<r[1]){i.label=r[1],r=o;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(o);break}r[2]&&i.ops.pop(),i.trys.pop();continue}o=l.call(e,i)}catch(e){o=[6,e],t=0}finally{a=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@libs/filterInputs"),r=require("@libs/defaultCover"),i=require("@libs/fetch"),n=require("@libs/novelStatus"),o=require("htmlparser2"),u=a(require("dayjs")),s=function(){function a(){var e=this;this.id="AT",this.name="Автор Тудей",this.icon="src/ru/authortoday/icon.png",this.site="https://author.today",this.version="1.2.1",this.userAgent="Mozilla/5.0 (Android 15; Mobile; rv:138.0) Gecko/138.0 Firefox/138.0",this.resolveUrl=function(l,a){return e.site+(a?"/work/":"/reader/")+l},this.filters={sort:{label:"Сортировка",value:"popular",options:[{label:"По популярности",value:"popular"},{label:"По количеству лайков",value:"likes"},{label:"По комментариям",value:"comments"},{label:"По новизне",value:"recent"},{label:"По просмотрам",value:"views"},{label:"Набирающие популярность",value:"trending"}],type:t.FilterTypes.Picker},genre:{label:"Жанры",value:"",options:[{label:"Все",value:""},{label:"Альтернативная история",value:"sf-history"},{label:"Антиутопия",value:"dystopia"},{label:"Бизнес-литература",value:"biznes-literatura"},{label:"Боевая фантастика",value:"sf-action"},{label:"Боевик",value:"action"},{label:"Боевое фэнтези",value:"fantasy-action"},{label:"Бояръ-Аниме",value:"boyar-anime"},{label:"Героическая фантастика",value:"sf-heroic"},{label:"Героическое фэнтези",value:"heroic-fantasy"},{label:"Городское фэнтези",value:"urban-fantasy"},{label:"Детектив",value:"detective"},{label:"Детская литература",value:"detskaya-literatura"},{label:"Документальная проза",value:"non-fiction"},{label:"Историческая проза",value:"historical-fiction"},{label:"Исторические приключения",value:"historical-adventure"},{label:"Исторический детектив",value:"historical-mystery"},{label:"Исторический любовный роман",value:"historical-romance"},{label:"Историческое фэнтези",value:"historical-fantasy"},{label:"Киберпанк",value:"cyberpunk"},{label:"Короткий любовный роман",value:"short-romance"},{label:"Космическая фантастика",value:"sf-space"},{label:"ЛитРПГ",value:"litrpg"},{label:"Любовное фэнтези",value:"love-fantasy"},{label:"Любовные романы",value:"romance"},{label:"Мистика",value:"paranormal"},{label:"Назад в СССР",value:"back-to-ussr"},{label:"Научная фантастика",value:"science-fiction"},{label:"Подростковая проза",value:"teen-prose"},{label:"Политический роман",value:"political-fiction"},{label:"Попаданцы",value:"popadantsy"},{label:"Попаданцы в космос",value:"popadantsy-v-kosmos"},{label:"Попаданцы в магические миры",value:"popadantsy-v-magicheskie-miry"},{label:"Попаданцы во времени",value:"popadantsy-vo-vremeni"},{label:"Постапокалипсис",value:"postapocalyptic"},{label:"Поэзия",value:"poetry"},{label:"Приключения",value:"adventure"},{label:"Публицистика",value:"publicism"},{label:"Развитие личности",value:"razvitie-lichnosti"},{label:"Разное",value:"other"},{label:"РеалРПГ",value:"realrpg"},{label:"Романтическая эротика",value:"romantic-erotika"},{label:"Сказка",value:"fairy-tale"},{label:"Современная проза",value:"modern-prose"},{label:"Современный любовный роман",value:"contemporary-romance"},{label:"Социальная фантастика",value:"sf-social"},{label:"Стимпанк",value:"steampunk"},{label:"Темное фэнтези",value:"dark-fantasy"},{label:"Триллер",value:"thriller"},{label:"Ужасы",value:"horror"},{label:"Фантастика",value:"sci-fi"},{label:"Фантастический детектив",value:"detective-science-fiction"},{label:"Фанфик",value:"fanfiction"},{label:"Фэнтези",value:"fantasy"},{label:"Шпионский детектив",value:"spy-mystery"},{label:"Эпическое фэнтези",value:"epic-fantasy"},{label:"Эротика",value:"erotica"},{label:"Эротическая фантастика",value:"sf-erotika"},{label:"Эротический фанфик",value:"fanfiction-erotika"},{label:"Эротическое фэнтези",value:"fantasy-erotika"},{label:"Юмор",value:"humor"},{label:"Юмористическая фантастика",value:"sf-humor"},{label:"Юмористическое фэнтези",value:"ironical-fantasy"}],type:t.FilterTypes.Picker},form:{label:"Форма произведения",value:"",options:[{label:"Любой",value:""},{label:"Перевод",value:"translation"},{label:"Повесть",value:"tale"},{label:"Рассказ",value:"story"},{label:"Роман",value:"novel"},{label:"Сборник поэзии",value:"poetry"},{label:"Сборник рассказов",value:"story-book"}],type:t.FilterTypes.Picker},state:{label:"Статус произведения",value:"",options:[{label:"Любой статус",value:""},{label:"В процессе",value:"in-progress"},{label:"Завершено",value:"finished"}],type:t.FilterTypes.Picker},series:{label:"Статус цикла",value:"",options:[{label:"Не важно",value:""},{label:"Вне цикла",value:"out"},{label:"Цикл завершен",value:"finished"},{label:"Цикл не завершен",value:"unfinished"}],type:t.FilterTypes.Picker},access:{label:"Тип доступа",value:"",options:[{label:"Любой",value:""},{label:"Платный",value:"paid"},{label:"Бесплатный",value:"free"}],type:t.FilterTypes.Picker},promo:{label:"Промо-фрагмент",value:"hide",options:[{label:"Скрывать",value:"hide"},{label:"Показывать",value:"show"}],type:t.FilterTypes.Picker}}}return a.prototype.parseNovels=function(e){return(0,i.fetchApi)(e,{headers:{"User-Agent":this.userAgent}}).then((function(e){return e.text()})).then((function(e){var l=[],a={},t=!1,i=!1,n=new o.Parser({onopentag:function(e,l){"a"===e&&"work-row item-link item-content"===l.class&&l.href&&(a.path=l.href.replace(/\D/g,""),t=!0),t&&"h4"===e&&"work-title"===l.class&&(i=!0),t&&"img"===e&&"Обложка"===l.alt&&(a.cover=l["data-src"])},ontext:function(e){i&&(a.name=e.trim())},onclosetag:function(e){"h4"===e&&(i=!1),"a"===e&&t&&(a.cover||(a.cover=r.defaultCover),l.push(a),a={},t=!1)}});return n.write(e),n.end(),l}))},a.prototype.popularNovels=function(a,t){return e(this,arguments,void 0,(function(e,a){var t,r,i,n,o,u,s,v,c=a.showLatestNovels,h=a.filters;return l(this,(function(l){return t=this.site+"/work/genre/"+((null===(r=null==h?void 0:h.genre)||void 0===r?void 0:r.value)||"all"),t+="?sorting="+(c?"recent":(null===(i=null==h?void 0:h.sort)||void 0===i?void 0:i.value)||"popular"),(null===(n=null==h?void 0:h.form)||void 0===n?void 0:n.value)&&(t+="&form="+h.form.value),(null===(o=null==h?void 0:h.state)||void 0===o?void 0:o.value)&&(t+="&state="+h.state.value),(null===(u=null==h?void 0:h.series)||void 0===u?void 0:u.value)&&(t+="&series="+h.series.value),(null===(s=null==h?void 0:h.access)||void 0===s?void 0:s.value)&&(t+="&access="+h.access.value),(null===(v=null==h?void 0:h.promo)||void 0===v?void 0:v.value)&&(t+="&promo="+h.promo.value),t+="&page="+e,[2,this.parseNovels(t)]}))}))},a.prototype.parseNovel=function(a){return e(this,void 0,void 0,(function(){var e,t,s,v,c,h,p,b,f,d,y,m;return l(this,(function(l){switch(l.label){case 0:return[4,(0,i.fetchApi)(this.resolveUrl(a,!0),{headers:{"User-Agent":this.userAgent}}).then((function(e){return e.text()}))];case 1:return e=l.sent(),t={path:a,name:"",author:"",summary:""},s=[],v=!1,c=!1,h=!1,p=!1,b=!1,f=!1,d=!1,y={},m=new o.Parser({onopentag:function(e,l){"h1"===e&&"card-title"===l.class&&(v=!0),"img"===e&&"cover-image"===l.class&&(t.cover=l.src),"a"===e&&l.href&&l.href.endsWith("/works")&&(c=!0),"div"===e&&"rich-content"===l.class&&(h=!0),"br"===e&&h&&(t.summary+="\n"),"noindex"===e&&(p=!0,t.genres&&(t.genres="")),"label"===e&&l.class&&l.class.includes("label")&&(b=!0),"li"===e&&"clearfix"===l.class&&(f=!0),"a"===e&&f&&l.href&&(d=!0,y.path=l.href.replace("/reader/","")),"span"===e&&l["data-time"]&&(y.releaseTime=(0,u.default)(l["data-time"]).format("LLL"))},ontext:function(e){if(v&&(t.name=e.trim(),v=!1),c&&e.trim()&&(t.author+=e.trim()+", "),h&&(t.summary+=e.trim()),p&&(t.genres+=e),b)switch(e.trim()){case"в процессе":t.status=n.NovelStatus.Ongoing;break;case"весь текст":t.status=n.NovelStatus.Completed;break;default:t.status=n.NovelStatus.Unknown}d&&(y.name=e.trim(),d=!1)},onclosetag:function(e){var l;"div"===e&&c&&(c=!1,t.author=null===(l=t.author)||void 0===l?void 0:l.slice(0,-2)),"div"===e&&h&&(h=!1),"noindex"===e&&(p=!1),"label"===e&&(b=!1),"li"===e&&f&&(y.chapterNumber=s.length,y.path&&(null==s||s.push(y)),y={},f=!1)}}),m.write(e),m.end(),t.cover||(t.cover=r.defaultCover),s.length||s.push({name:"Рассказ",path:a}),t.chapters=s,[2,t]}}))}))},a.prototype.parseChapter=function(a){return e(this,void 0,void 0,(function(){var e,t,r,n,o,u,s,v,c,h,p,b,f,d;return l(this,(function(l){switch(l.label){case 0:return[4,(0,i.fetchApi)(this.resolveUrl(a),{headers:{"User-Agent":this.userAgent}}).then((function(e){return e.text()}))];case 1:if(e=l.sent(),t=a.split("/"),r=t[0],n=t[1],o=null===(b=null===(p=e.match(/userId:(.*?),/))||void 0===p?void 0:p[1])||void 0===b?void 0:b.trim(),u="null"===o?"":o,n||(n=(null===(d=null===(f=e.match(/chapterId:(.*?),/))||void 0===f?void 0:f[1])||void 0===d?void 0:d.trim())||""),!n)throw new Error("Chapter ID not found");return[4,(0,i.fetchApi)(this.site+"/reader/"+r+"/chapter?id="+n,{headers:{"User-Agent":this.userAgent}})];case 2:return[4,(s=l.sent()).json()];case 3:if(v=l.sent(),!(c=s.headers.get("reader-secret")))throw new Error("Failed to find the token\n"+v.messages);return h=function(e,l,a){void 0===a&&(a="");for(var t=(l.split("").reverse().join("")+"@_@"+a).split("").map((function(e){return e.charCodeAt(0)})),r=t.length,i="",n=0;n<e.length;n++)i+=String.fromCharCode(e.charCodeAt(n)^t[n%r]);return i}(v.data.text,c,u),[2,h]}}))}))},a.prototype.searchNovels=function(a){return e(this,arguments,void 0,(function(e,a){var t;return void 0===a&&(a=1),l(this,(function(l){return t=this.site+"/search?category=works&q="+e+"&page="+a,[2,this.parseNovels(t)]}))}))},a}();exports.default=new s;