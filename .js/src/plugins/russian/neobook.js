var e=this&&this.__awaiter||function(e,t,l,a){return new(l||(l=Promise))((function(n,o){function r(e){try{u(a.next(e))}catch(e){o(e)}}function i(e){try{u(a.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof l?t:new l((function(e){e(t)}))).then(r,i)}u((a=a.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var l,a,n,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},r=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return r.next=i(0),r.throw=i(1),r.return=i(2),"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function i(i){return function(u){return function(i){if(l)throw new TypeError("Generator is already executing.");for(;r&&(r=0,i[0]&&(o=0)),o;)try{if(l=1,a&&(n=2&i[0]?a.return:i[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,i[1])).done)return n;switch(a=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,a=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){o.label=i[1];break}if(6===i[0]&&o.label<n[1]){o.label=n[1],n=i;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(i);break}n[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],a=0}finally{l=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}};Object.defineProperty(exports,"__esModule",{value:!0});var l=require("@libs/filterInputs"),a=require("@libs/defaultCover"),n=require("@libs/fetch"),o=require("@libs/novelStatus"),r={0:o.NovelStatus.Unknown,1:o.NovelStatus.Ongoing,2:o.NovelStatus.Completed,3:o.NovelStatus.OnHiatus,4:o.NovelStatus.Cancelled},i=function(){function i(){var e=this;this.id="neobook",this.name="Neobook",this.site="https://neobook.org",this.apiSite="https://api.neobook.org/",this.version="1.0.1",this.icon="src/ru/neobook/icon.png",this.popularNovels=this.fetchNovels,this.resolveUrl=function(t,l){return e.site+(l?"/book/":"/reader/")+t},this.filters={sort:{label:"Сортировка:",value:"popular",options:[{label:"Сначала популярные",value:"popular"},{label:"Сначала новые",value:"new"},{label:"В случайном порядке",value:"rand"}],type:l.FilterTypes.Picker},timeread:{label:"Время прочтения:",value:"0-999999",options:[{label:"Все",value:"0-999999"},{label:"Менее 15 минут",value:"0-900"},{label:"15-30 минут",value:"900-1800"},{label:"30-60 минут",value:"1800-3600"},{label:"1-2 часа",value:"3600-7200"},{label:"Более 2 часов",value:"7200-999999"}],type:l.FilterTypes.Picker},category:{label:"Жанр:",value:"",options:[{label:"Все",value:""},{label:"Антиутопия",value:"10"},{label:"Детектив",value:"13"},{label:"Детские книги",value:"14"},{label:"Драма",value:"15"},{label:"Другое",value:"16"},{label:"История",value:"18"},{label:"Мелодрама",value:"21"},{label:"Мистика",value:"22"},{label:"Научная фантастика",value:"23"},{label:"Нон-фикшн",value:"35"},{label:"Подростки и молодежь",value:"26"},{label:"Постапокалипсис",value:"27"},{label:"Поэзия",value:"28"},{label:"Приключения",value:"29"},{label:"Рассказ",value:"34"},{label:"Роман",value:"36"},{label:"Творчество",value:"40"},{label:"Триллер",value:"91"},{label:"Ужасы",value:"90"},{label:"Фантастика",value:"41"},{label:"Фанфик",value:"42"},{label:"Фэнтези",value:"44"},{label:"Эротика",value:"46"},{label:"Юмор",value:"47"}],type:l.FilterTypes.Picker},tags:{label:"Тэги:",value:"",type:l.FilterTypes.TextInput}}}return i.prototype.fetchNovels=function(l,o,r){return e(this,arguments,void 0,(function(e,l,o){var r,i,u,s,v,c,p,d,h,f=l.filters,b=l.showLatestNovels;return t(this,(function(t){switch(t.label){case 0:return(r=new FormData).append("version","4.0"),r.append("uid","0"),r.append("utoken",""),r.append("resource","general"),r.append("action","get_bundle"),r.append("bundle","bundle_books"),r.append("target","feed"),r.append("page",e.toString()),r.append("filter_category_id",(null===(s=null==f?void 0:f.category)||void 0===s?void 0:s.value)||"0"),r.append("filter_completed","-1"),r.append("filter_search",o||""),r.append("filter_tags",(null===(v=null==f?void 0:f.tags)||void 0===v?void 0:v.value)||""),r.append("filter_sort",b?"new":(null===(c=null==f?void 0:f.sort)||void 0===c?void 0:c.value)||"popular"),r.append("filter_timeread",(null===(p=null==f?void 0:f.timeread)||void 0===p?void 0:p.value)||"0-999999"),[4,(0,n.fetchApi)(this.apiSite,{method:"post",body:r}).then((function(e){return e.json()}))];case 1:return i=t.sent().bundle_books,u=[],(null===(d=i.feed)||void 0===d?void 0:d.length)&&(null===(h=i.feed)||void 0===h||h.forEach((function(e){var t,l;return u.push({name:e.title,cover:(null===(l=null===(t=null==e?void 0:e.attachment)||void 0===t?void 0:t.image)||void 0===l?void 0:l.m)||a.defaultCover,path:e.token+"/"})}))),[2,u]}}))}))},i.prototype.searchNovels=function(l,a){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){return e={filters:void 0,showLatestNovels:!1},[2,this.fetchNovels(a,e,l)]}))}))},i.prototype.parseNovel=function(l){return e(this,void 0,void 0,(function(){var e,i,u,s,v,c,p,d,h,f,b,m;return t(this,(function(t){switch(t.label){case 0:return[4,(0,n.fetchApi)(this.resolveUrl(l,!0)).then((function(e){return e.text()}))];case 1:return e=t.sent(),i={path:l,name:"",cover:a.defaultCover},(u=e.match(/var postData = ({.*?});/))instanceof Array&&u[1]&&(s=JSON.parse(u[1]),i.name=s.title,i.summary=(null===(p=null===(c=s.text)||void 0===c?void 0:c.replace)||void 0===p?void 0:p.call(c,/<br>/g,"\n"))||s.text_fix,i.author=s.user&&s.user.firstname&&s.user.lastname?s.user.firstname+" "+s.user.lastname:(null===(d=s.user)||void 0===d?void 0:d.initials)||"",i.status=r[s.status||"0"]||o.NovelStatus.Unknown,(null===(f=null===(h=s.attachment)||void 0===h?void 0:h.image)||void 0===f?void 0:f.m)&&(i.cover=s.attachment.image.m),(null===(b=s.tags)||void 0===b?void 0:b.length)&&(i.genres=s.tags.join(",")),v=[],null===(m=s.chapters)||void 0===m||m.forEach((function(e,t){"1"==e.access&&"1"==e.status&&v.push({name:e.title||"Глава "+(t+1),path:"?book=".concat(s.token,"&chapter=").concat(e.token),releaseTime:null,chapterNumber:Number(e.sort)||t+1})})),i.chapters=v),[2,i]}}))}))},i.prototype.parseChapter=function(l){return e(this,void 0,void 0,(function(){var e,a,o,r,i,u,s,v,c;return t(this,(function(t){switch(t.label){case 0:return[4,(0,n.fetchApi)(this.resolveUrl(l)).then((function(e){return e.text()}))];case 1:return e=t.sent(),a=e.match(/var data = ({.*?});/),o="",a instanceof Array&&a[1]&&(r=l.split("=")[2],i=JSON.parse(a[1]),u=null===(v=null===(s=i.chapters)||void 0===s?void 0:s.find)||void 0===v?void 0:v.call(s,(function(e){return e.token==r})),o=((null===(c=null==u?void 0:u.data)||void 0===c?void 0:c.html)||"").replace(/<br>/g,"")),[2,o]}}))}))},i}();exports.default=new i;