var e,t=this&&this.__extends||(e=function(t,a){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])},e(t,a)},function(t,a){if("function"!=typeof a&&null!==a)throw new TypeError("Class extends value "+String(a)+" is not a constructor or null");function l(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(l.prototype=a.prototype,new l)}),a=this&&this.__awaiter||function(e,t,a,l){return new(a||(a=Promise))((function(n,r){function o(e){try{u(l.next(e))}catch(e){r(e)}}function i(e){try{u(l.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(o,i)}u((l=l.apply(e,t||[])).next())}))},l=this&&this.__generator||function(e,t){var a,l,n,r={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=i(0),o.throw=i(1),o.return=i(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(i){return function(u){return function(i){if(a)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(r=0)),r;)try{if(a=1,l&&(n=2&i[0]?l.return:i[0]?l.throw||((n=l.return)&&n.call(l),0):l.next)&&!(n=n.call(l,i[1])).done)return n;switch(l=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return r.label++,{value:i[1],done:!1};case 5:r.label++,l=i[1],i=[0];continue;case 7:i=r.ops.pop(),r.trys.pop();continue;default:if(!(n=r.trys,(n=n.length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){r=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){r.label=i[1];break}if(6===i[0]&&r.label<n[1]){r.label=n[1],n=i;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(i);break}n[2]&&r.ops.pop(),r.trys.pop();continue}i=t.call(e,r)}catch(e){i=[6,e],l=0}finally{a=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}};Object.defineProperty(exports,"__esModule",{value:!0});var n=require("cheerio"),r=require("@libs/fetch"),o=require("@libs/novelStatus"),i=require("@libs/filterInputs"),u=require("@/types/constants"),s=function(){function e(){this.id="novelfire",this.name="Novel Fire",this.version="1.1.2",this.icon="src/en/novelfire/icon.png",this.site="https://novelfire.net/",this.filters={sort:{label:"Sort Results By",value:"rank-top",options:[{label:"Rank (Top)",value:"rank-top"},{label:"Rating Score (Top)",value:"rating-score-top"},{label:"Review Count (Most)",value:"review"},{label:"Comment Count (Most)",value:"comment"},{label:"Bookmark Count (Most)",value:"bookmark"},{label:"Today Views (Most)",value:"today-view"},{label:"Monthly Views (Most)",value:"monthly-view"},{label:"Total Views (Most)",value:"total-view"},{label:"Title (A>Z)",value:"abc"},{label:"Title (Z>A)",value:"cba"},{label:"Last Updated (Newest)",value:"date"},{label:"Chapter Count (Most)",value:"chapter-count-most"}],type:i.FilterTypes.Picker},status:{label:"Translation Status",value:"-1",options:[{label:"All",value:"-1"},{label:"Completed",value:"1"},{label:"Ongoing",value:"0"}],type:i.FilterTypes.Picker},genre_operator:{label:"Genres (And/Or/Exclude)",value:"and",options:[{label:"AND",value:"and"},{label:"OR",value:"or"},{label:"EXCLUDE",value:"exclude"}],type:i.FilterTypes.Picker},genres:{label:"Genres",value:[],options:[{label:"Action",value:"3"},{label:"Adult",value:"28"},{label:"Adventure",value:"4"},{label:"Anime",value:"46"},{label:"Arts",value:"47"},{label:"Comedy",value:"5"},{label:"Drama",value:"24"},{label:"Eastern",value:"44"},{label:"Ecchi",value:"26"},{label:"Fan-fiction",value:"48"},{label:"Fantasy",value:"6"},{label:"Game",value:"19"},{label:"Gender Bender",value:"25"},{label:"Harem",value:"7"},{label:"Historical",value:"12"},{label:"Horror",value:"37"},{label:"Isekai",value:"49"},{label:"Josei",value:"2"},{label:"Lgbt+",value:"45"},{label:"Magic",value:"50"},{label:"Magical Realism",value:"51"},{label:"Manhua",value:"52"},{label:"Martial Arts",value:"15"},{label:"Mature",value:"8"},{label:"Mecha",value:"34"},{label:"Military",value:"53"},{label:"Modern Life",value:"54"},{label:"Movies",value:"55"},{label:"Mystery",value:"16"},{label:"Other",value:"64"},{label:"Psychological",value:"9"},{label:"Realistic Fiction",value:"56"},{label:"Reincarnation",value:"43"},{label:"Romance",value:"1"},{label:"School Life",value:"21"},{label:"Sci-fi",value:"20"},{label:"Seinen",value:"10"},{label:"Shoujo",value:"38"},{label:"Shoujo Ai",value:"57"},{label:"Shounen",value:"17"},{label:"Shounen Ai",value:"39"},{label:"Slice of Life",value:"13"},{label:"Smut",value:"29"},{label:"Sports",value:"42"},{label:"Supernatural",value:"18"},{label:"System",value:"58"},{label:"Tragedy",value:"32"},{label:"Urban",value:"63"},{label:"Urban Life",value:"59"},{label:"Video Games",value:"60"},{label:"War",value:"61"},{label:"Wuxia",value:"31"},{label:"Xianxia",value:"23"},{label:"Xuanhuan",value:"22"},{label:"Yaoi",value:"14"},{label:"Yuri",value:"62"}],type:i.FilterTypes.CheckboxGroup},language:{label:"Language",value:[],options:[{label:"Chinese",value:"1"},{label:"Korean",value:"2"},{label:"Japanese",value:"3"},{label:"English",value:"4"}],type:i.FilterTypes.CheckboxGroup},rating_operator:{label:"Rating (Min/Max)",value:"min",options:[{label:"Min",value:"min"},{label:"Max",value:"max"}],type:i.FilterTypes.Picker},rating:{label:"Rating",value:"0",options:[{label:"All",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"4",value:"4"},{label:"5",value:"5"}],type:i.FilterTypes.Picker},chapters:{label:"Chapters",value:"0",options:[{label:"All",value:"0"},{label:"<50",value:"1,49"},{label:"50-100",value:"50,100"},{label:"100-200",value:"100,200"},{label:"200-500",value:"200,500"},{label:"500-1000",value:"500,1000"},{label:">1000",value:"1001,1000000"}],type:i.FilterTypes.Picker}}}return e.prototype.getCheerio=function(e,t){return a(this,void 0,void 0,(function(){var a,o,i;return l(this,(function(l){switch(l.label){case 0:return[4,(0,r.fetchApi)(e)];case 1:if(!(a=l.sent()).ok&&1!=t)throw new Error("Could not reach site ("+a.status+") try to open in webview.");return i=n.load,[4,a.text()];case 2:if((o=i.apply(void 0,[l.sent()]))("title").text().includes("Cloudflare"))throw new Error("Cloudflare is blocking requests. Try again later.");return[2,o]}}))}))},e.prototype.popularNovels=function(e,t){return a(this,arguments,void 0,(function(e,t){var a,n,r,o,i,u,s,c,v,p=this,h=t.showLatestNovels,b=t.filters;return l(this,(function(t){switch(t.label){case 0:if(a=this.site+"search-adv",h)a+="?ctgcon=and&totalchapter=0&ratcon=min&rating=0&status=-1&sort=date&tagcon=and&page=".concat(e);else if(b){for(n=new URLSearchParams,r=0,o=b.language.value;r<o.length;r++)i=o[r],n.append("country_id[]",i);for(n.append("ctgcon",b.genre_operator.value),u=0,s=b.genres.value;u<s.length;u++)c=s[u],n.append("categories[]",c);n.append("totalchapter",b.chapters.value),n.append("ratcon",b.rating_operator.value),n.append("rating",b.rating.value),n.append("status",b.status.value),n.append("sort",b.sort.value),n.append("page",e.toString()),a+="?".concat(n.toString())}else a+="?ctgcon=and&totalchapter=0&ratcon=min&rating=0&status=-1&sort=rank-top&page=".concat(e);return[4,this.getCheerio(a,!1)];case 1:return[2,(v=t.sent())(".novel-item").map((function(e,t){var a=v(t).find(".novel-title > a").text()||"No Title Found",l=v(t).find(".novel-cover > img").attr("data-src"),n=v(t).find(".novel-title > a").attr("href");if(n)return{name:a,cover:l,path:n.replace(p.site,"")}})).get().filter((function(e){return null!==e}))]}}))}))},e.prototype.getAllChapters=function(e,t){return a(this,void 0,void 0,(function(){var a,n,r,o,i,u,s,v,p,h,b,f,d,g,y,m,w=this;return l(this,(function(l){switch(l.label){case 0:a=Array.from({length:t},(function(e,t){return t+1})),n=[],r=5,o=10,i=3.5,u=[],s=0,l.label=1;case 1:if(!(s<a.length))return[3,11];v=a.slice(s,s+r),p=v[0],h=v[v.length-1],b=0,l.label=2;case 2:if(!(b<o))return[3,10];l.label=3;case 3:return l.trys.push([3,5,,9]),[4,Promise.all(v.map((function(t){return w.getChaptersOnPage(e,t.toString())})))];case 4:return f=l.sent(),u.push.apply(u,f),[3,10];case 5:if(!((d=l.sent())instanceof c))return[3,7];if(b+=1,console.warn("[pages=".concat(p,"-").concat(h,"] Novel Fire is rate limiting requests. Retry attempt ").concat(b+1," in ").concat(i," seconds...")),b===o)throw d;return[4,new Promise((function(e){return setTimeout(e,1e3*i)}))];case 6:return l.sent(),[3,8];case 7:throw d;case 8:return[3,9];case 9:return[3,2];case 10:return s+=r,[3,1];case 11:for(g=0,y=u;g<y.length;g++)m=y[g],n.push.apply(n,m);return[2,n]}}))}))},e.prototype.getChaptersOnPage=function(e,t){return a(this,void 0,void 0,(function(){var a,o,i,u=this;return l(this,(function(l){switch(l.label){case 0:return a="".concat(this.site).concat(e,"/chapters?page=").concat(t),[4,(0,r.fetchApi)(a)];case 1:return[4,l.sent().text()];case 2:if(o=l.sent(),(i=(0,n.load)(o)).text().includes("You are being rate limited"))throw new c;return[2,i(".chapter-list li").map((function(e,t){var a=i(t).find("a").attr("title")||"No Title Found",l=i(t).find("a").attr("href");return l?{name:a,path:l.replace(u.site,"")}:null})).get().filter((function(e){return null!==e}))]}}))}))},e.prototype.getTotalPages=function(e){var t=e(".header-stats .icon-book-open").parent().text().trim();return Math.ceil(parseInt(t)/100)},e.prototype.parseNovel=function(e){return a(this,void 0,void 0,(function(){var t,a,n,r,i,s,c,v,p,h,b,f,d,g,y;return l(this,(function(l){switch(l.label){case 0:return[4,this.getCheerio(this.site+e,!1)];case 1:return t=l.sent(),a=this.site,(n={path:e}).name=null!==(d=null!==(f=t(".novel-title").text().trim())&&void 0!==f?f:t(".cover > img").attr("alt"))&&void 0!==d?d:"No Titled Found",r=null!==(g=t(".cover > img").attr("data-src"))&&void 0!==g?g:t(".cover > img").attr("src"),n.cover=r?new URL(r,a).href:u.defaultCover,n.genres=t(".categories .property-item").map((function(e,a){return t(a).text()})).toArray().join(","),(i=t(".summary .content").text().trim())?(i=i.replace("Show More",""),n.summary=i):n.summary="No Summary Found",n.author=t(".author .property-item > span").text(),s=t(".header-stats .ongoing").text()||t(".header-stats .completed").text()||"Unknown",c={ongoing:o.NovelStatus.Ongoing,hiatus:o.NovelStatus.OnHiatus,dropped:o.NovelStatus.Cancelled,cancelled:o.NovelStatus.Cancelled,completed:o.NovelStatus.Completed,unknown:o.NovelStatus.Unknown},n.status=null!==(y=c[s.toLowerCase()])&&void 0!==y?y:o.NovelStatus.Unknown,n.rating=parseFloat(t(".nub").text().trim()),v=n,p=this.getAllChapters,h=[e],b=this.getTotalPages,[4,this.getCheerio(this.site+e,!1)];case 2:return[4,p.apply(this,h.concat([b.apply(this,[l.sent()])]))];case 3:return v.chapters=l.sent(),[2,n]}}))}))},e.prototype.parseChapter=function(e){return a(this,void 0,void 0,(function(){var t,a,n,r;return l(this,(function(l){switch(l.label){case 0:return t=this.site+e,[4,this.getCheerio(t,!1)];case 1:return a=l.sent(),n=a("#content"),a(n).find("div").remove(),[2,(null===(r=n.html())||void 0===r?void 0:r.replace(/&nbsp;/g," "))||""]}}))}))},e.prototype.searchNovels=function(e,t){return a(this,void 0,void 0,(function(){var a,o,i,u=this;return l(this,(function(l){switch(l.label){case 0:return a="".concat(this.site,"search?keyword=").concat(encodeURIComponent(e),"&page=").concat(t),[4,(0,r.fetchApi)(a)];case 1:return[4,l.sent().text()];case 2:return o=l.sent(),[2,(i=(0,n.load)(o))(".novel-list.chapters .novel-item").map((function(e,t){var a=i(t).find("a").attr("title")||"No Title Found",l=i(t).find(".novel-cover > img").attr("src"),n=i(t).find("a").attr("href");return n?{name:a,cover:l,path:n.replace(u.site,"")}:null})).get().filter((function(e){return null!==e}))]}}))}))},e}();exports.default=new s;var c=function(e){function a(t){void 0===t&&(t="Novel Fire is rate limiting requests");var a=e.call(this,t)||this;return a.name="NovelFireError",a}return t(a,e),a}(Error);