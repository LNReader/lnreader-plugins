var t=this&&this.__assign||function(){return t=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var s in e=arguments[r])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},t.apply(this,arguments)},e=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(s,a){function i(t){try{c(n.next(t))}catch(t){a(t)}}function o(t){try{c(n.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,o)}c((n=n.apply(t,e||[])).next())}))},r=this&&this.__generator||function(t,e){var r,n,s,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=o(0),i.throw=o(1),i.return=o(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(o){return function(c){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,o[0]&&(a=0)),a;)try{if(r=1,n&&(s=2&o[0]?n.return:o[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,o[1])).done)return s;switch(n=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(s=a.trys,(s=s.length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){a.label=o[1];break}if(6===o[0]&&a.label<s[1]){a.label=s[1],s=o;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(o);break}s[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{r=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var n=require("htmlparser2"),s=require("@libs/fetch"),a=require("@libs/novelStatus"),i=new(function(){function i(t){var e=this;this.parseDate=function(t){var r=new Date;if(!t)return r.toISOString();if("ranobes-ru"===e.id){if(t.includes(" в "))return t.replace(" в "," г., ");var n=t.split(", "),s=n[0],a=n[1];if(!a)return r.toISOString();var i=a.split(":"),o=i[0],c=i[1];switch(s){case"Сегодня":r.setHours(parseInt(o,10)),r.setMinutes(parseInt(c,10));break;case"Вчера":r.setDate(r.getDate()-1),r.setHours(parseInt(o,10)),r.setMinutes(parseInt(c,10));break;default:return r.toISOString()}}else{var l=t.split(" "),u=l[0],h=l[1];if("ago"!==l[2])return r.toISOString();switch(h){case"minutes":r.setMinutes(parseInt(u,10));break;case"hour":case"hours":r.setHours(parseInt(u,10));break;case"day":case"days":r.setDate(r.getDate()-parseInt(u,10));break;case"month":case"months":r.setMonth(r.getMonth()-parseInt(u,10));break;case"year":case"years":r.setFullYear(r.getFullYear()-parseInt(u,10));break;default:return r.toISOString()}}return r.toISOString()},this.id=t.id,this.name=t.sourceName,this.icon="multisrc/ranobes/ranobes/icon.png",this.site=t.sourceSite,this.version="2.0.2",this.options=t.options}return i.prototype.safeFecth=function(t){return e(this,arguments,void 0,(function(t,e){var n,a,i,o,c;return void 0===e&&(e={}),r(this,(function(r){switch(r.label){case 0:return[4,(0,s.fetchApi)(t,e)];case 1:if(!(n=r.sent()).ok)throw new Error("Could not reach site ("+n.status+") try to open in webview.");return[4,n.text()];case 2:if(a=r.sent(),(i=null===(c=null===(o=a.match(/<title>(.*?)<\/title>/))||void 0===o?void 0:o[1])||void 0===c?void 0:c.trim())&&("Bot Verification"==i||"You are being redirected..."==i||"Un instant..."==i||"Just a moment..."==i||"Redirecting..."==i))throw new Error("Captcha error, please open in webview");return[2,a]}}))}))},i.prototype.parseNovels=function(t){var e=[],r={name:""},s=this.site,a=!1,i=!1,o=!1,c=new n.Parser({onopentag:function(t,n){var c,l;(null===(c=n.class)||void 0===c?void 0:c.includes("short-cont"))&&(a=!0),a&&("h2"===t&&(null===(l=n.class)||void 0===l?void 0:l.includes("title"))&&(i=!0),i&&"a"===t&&(r.path=n.href.slice(s.length),o=!0),"figure"===t&&(r.cover=n.style.replace(/.*url\((.*?)\)./g,"$1")),r.path&&r.cover&&(e.push(r),(r={}).name=""))},ontext:function(t){o&&(r.name+=t)},onclosetag:function(t){"h2"===t&&(o=!1,i=!1),"figure"===t&&(a=!1)}});return c.write(t),c.end(),e},i.prototype.parseChapters=function(t){var e=this,r=[];return t.chapters.map((function(t){r.push({name:t.title,releaseTime:new Date(t.date).toISOString(),path:t.link.slice(e.site.length)})})),r.reverse()},i.prototype.popularNovels=function(t){return e(this,void 0,void 0,(function(){var e,n;return r(this,(function(r){switch(r.label){case 0:return e="".concat(this.site,"/").concat(this.options.path,"/page/").concat(t,"/"),[4,this.safeFecth(e)];case 1:return n=r.sent(),[2,this.parseNovels(n)]}}))}))},i.prototype.parseNovel=function(s){return e(this,void 0,void 0,(function(){var e,i,o,c,l,u,h,p,f,d,v,g,m,b,w,y,S,O,_,I;return r(this,(function(r){switch(r.label){case 0:return e=this.site,[4,this.safeFecth(e+s)];case 1:return i=r.sent(),o={path:s,name:"",summary:"",chapters:[],totalPages:1},c=!1,l=!1,u=!1,h=!1,p=!1,f=!1,d=!1,v=!1,g=!1,m=!1,b=!1,w=[],y=[],S={},O=0,_=this.parseDate,(I=new n.Parser({onopentag:function(t,r){"poster"===r.class&&(c=!0),c&&"img"===t&&(o.name=r.alt,o.cover=e+r.src),("div"===t&&"moreless cont-text showcont-h"===r.class||"cont-text showcont-h"===r.class&&"description"===r.itemprop)&&(u=!0),"li"===t&&r.title&&(r.title.includes("Original status")||r.title.includes("Статус оригинала"))&&(h=!0),"a"===t&&"chapter"===r.rel&&(g=!0,S.path=r.href.replace(e,"")),g&&"span"===t&&"title ellipses"===r.class&&(m=!0),g&&"span"===t&&"grey"===r.class&&(b=!0),"li"!==t||"Glossary + illustrations + division of chapters, etc."!=r.title&&"Глоссарий + иллюстраций + разделение глав и т.д."!==r.title||(v=!0)},onopentagname:function(t){u&&"br"===t&&(o.summary+="\n"),h&&"a"===t&&(p=!0),f&&"a"===t&&(d=!0)},onattribute:function(t,e){"itemprop"===t&&"creator"===e&&(l=!0),"id"===t&&"mc-fs-genre"===e&&(f=!0)},ontext:function(t){if(l&&(o.author=t),u&&(o.summary+=t.trim()),p&&(o.status="Ongoing"===t||"В процессе"==t?a.NovelStatus.Ongoing:a.NovelStatus.Completed),d&&w.push(t),v){var e=t.replace(/\D/g,"");e&&(O=parseInt(e,10))}g&&(m&&(S.name=t.trim()),b&&(S.releaseTime=_(t.trim())))},onclosetag:function(e){"a"===e&&(c=!1,l=!1,p=!1,d=!1,h=!1),"div"===e&&(u=!1,f=!1),"li"===e&&(v=!1),"a"===e&&(g=!1,S.name&&(y.push(t(t({},S),{page:"1"})),S={})),"span"===e&&(m&&(m=!1),b&&(b=!1))}})).write(i),I.end(),o.genres=w.join(", "),o.totalPages=Math.ceil((O||1)/25),o.chapters=y,o.chapters[0].path&&(o.latestChapter=o.chapters[0]),[2,o]}}))}))},i.prototype.parsePage=function(t,s){return e(this,void 0,void 0,(function(){var e,a,i,o,c,l,u,h,p,f,d,v,g,m;return r(this,(function(r){switch(r.label){case 0:return e="ranobes"==this.id?t.split("-")[0]:"/"+t.split("-").slice(1).join("-").split(".")[0],a=this.site+"/chapters"+e.replace(this.options.path+"/",""),[4,this.safeFecth(a+"/page/"+s)];case 1:return i=r.sent(),o=this.site,c=!1,l=!1,u=!1,h=!1,p=[],f={},d=this.parseDate,v={pages_count:"",chapters:[]},(g=new n.Parser({onopentag:function(t,e){"div"===t&&"cat_block cat_line"===e.class&&(l=!0),l&&"a"===t&&e.title&&e.href&&(f.name=e.title,f.path=e.href.replace(o,"")),"span"===t&&"grey small"===e.class&&(u=!0),"small"===t&&u&&(h=!0)},ontext:function(t){h&&(f.releaseTime=d(t.trim())),c&&t.includes("window.__DATA__ =")&&(v=JSON.parse(t.replace("window.__DATA__ =","")))},onclosetag:function(t){"a"===t&&f.name&&(p.push(f),f={}),"div"===t&&(l=!1),"span"===t&&(u=!1),"small"===t&&(h=!1),"main"===t&&(c=!0),"script"===t&&(c=!1)}})).write(i),g.end(),(null===(m=v.chapters)||void 0===m?void 0:m.length)&&(p=this.parseChapters(v)),[2,{chapters:p}]}}))}))},i.prototype.parseChapter=function(t){return e(this,void 0,void 0,(function(){var e,n,s;return r(this,(function(r){switch(r.label){case 0:return[4,this.safeFecth(this.site+t)];case 1:return e=r.sent(),n=e.indexOf('<div class="text" id="arrticle">'),s=e.indexOf('<div class="category grey ellipses">',n),[2,e.substring(n,s)]}}))}))},i.prototype.searchNovels=function(t,n){return e(this,void 0,void 0,(function(){var e,s;return r(this,(function(r){switch(r.label){case 0:return"ranobes-ru"!==this.id?[3,2]:[4,this.safeFecth(this.site+"/index.php?do=search",{headers:{"Content-Type":"application/x-www-form-urlencoded",Referer:this.site+"/"},method:"POST",body:new URLSearchParams({do:"search",subaction:"search",search_start:n.toString(),story:t}).toString()})];case 1:return e=r.sent(),[3,4];case 2:return s="".concat(this.site,"/search/").concat(t,"/page/").concat(n),[4,this.safeFecth(s)];case 3:e=r.sent(),r.label=4;case 4:return[2,this.parseNovels(e)]}}))}))},i}())({id:"ranobes",sourceSite:"https://ranobes.top",sourceName:"Ranobes",options:{lang:"English",path:"novels"}});exports.default=i;