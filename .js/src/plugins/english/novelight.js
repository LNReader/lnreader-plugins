var t=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function a(t){try{c(i.next(t))}catch(t){o(t)}}function s(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,s)}c((i=i.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var n,i,r,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(o=0)),o;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,i=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){o.label=s[1];break}if(6===s[0]&&o.label<r[1]){o.label=r[1],r=s;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(s);break}r[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});var i=require("cheerio"),r=require("@libs/fetch"),o=require("@libs/defaultCover"),a=n(require("dayjs")),s=require("@libs/storage"),c=require("@libs/novelStatus"),u=function(){function n(){this.id="novelight",this.name="Novelight",this.version="1.1.1",this.icon="src/en/novelight/icon.png",this.site="https://novelight.net/",this.hideLocked=s.storage.get("hideLocked"),this.pluginSettings={hideLocked:{value:"",label:"Hide locked chapters",type:"Switch"}}}return n.prototype.popularNovels=function(n){return t(this,void 0,void 0,(function(){var t,a,s,c,u=this;return e(this,(function(e){switch(e.label){case 0:return t="".concat(this.site,"catalog/?ordering=popularity&page=").concat(n),[4,(0,r.fetchApi)(t).then((function(t){return t.text()}))];case 1:return a=e.sent(),s=(0,i.load)(a),c=[],s("a.item").each((function(t,e){var n=s(e).find("div.title").text().trim(),i=e.attribs.href,r=s(e).find("img").attr("src"),a=r?u.site+r:o.defaultCover;if(i){var l={name:n,cover:null!=a?a:o.defaultCover,path:i.replace("/","")};c.push(l)}})),[2,c]}}))}))},n.prototype.parseNovel=function(n){return t(this,void 0,void 0,(function(){var t,o,a,s,u,l,h,d,f,p;return e(this,(function(e){switch(e.label){case 0:return[4,(0,r.fetchApi)(this.site+n).then((function(t){return t.text()}))];case 1:for(t=e.sent(),o=(0,i.load)(t),a={path:n,name:o("h1").text()||"Untitled",cover:this.site+o(".poster > img").attr("src"),summary:o("section.text-info.section > p").text(),totalPages:o("#select-pagination-chapter > option").length,chapters:[]},s=o("div.mini-info > .item").toArray(),u="",l="",h=0,d=s;h<d.length;h++)f=d[h],"Status"===(p=o(f).find(".sub-header").text().trim())&&(u=o(f).find("div.info").text().trim()),"Translation"===p&&(l=o(f).find("div.info").text().trim()),"Author"===p&&(a.author=o(f).find("div.info").text().trim()),"Genres"===p&&(a.genres=o(f).find("div.info > a").map((function(t,e){return o(e).text()})).toArray().join(", "));return"cancelled"===u?a.status=c.NovelStatus.Cancelled:"releasing"===u||"ongoing"===l?a.status=c.NovelStatus.Ongoing:"completed"===u&&"completed"===l&&(a.status=c.NovelStatus.Completed),[2,a]}}))}))},n.prototype.parsePage=function(n,o){return t(this,void 0,void 0,(function(){var t,s,c,u,l,h,d,f,p,v,m,g,b=this;return e(this,(function(e){switch(e.label){case 0:return[4,(0,r.fetchApi)(this.site+n).then((function(t){return t.text()}))];case 1:return t=e.sent(),s=null===(d=null==t?void 0:t.match(/window\.CSRF_TOKEN = "([^"]+)"/))||void 0===d?void 0:d[1],c=null===(f=null==t?void 0:t.match(/const OBJECT_BY_COMMENT = ([0-9]+)/))||void 0===f?void 0:f[1],u=parseInt(null!==(g=null===(m=null===(v=null===(p=null==t?void 0:t.match(/<option value="([0-9]+)"/g))||void 0===p?void 0:p.at(-1))||void 0===v?void 0:v.match(/([0-9]+)/))||void 0===m?void 0:m[1])&&void 0!==g?g:"1"),[4,(0,r.fetchApi)("".concat(this.site,"/book/ajax/chapter-pagination?csrfmiddlewaretoken=").concat(s,"&book_id=").concat(c,"&page=").concat(u-parseInt(o)+1),{headers:{Host:this.site.replace("https://","").replace("/",""),Referer:this.site+n,"X-Requested-With":"XMLHttpRequest"}}).then((function(t){return t.json()})).then((function(t){return t.html}))];case 2:return l=e.sent(),h=[],(0,i.load)("<html>"+l+"</html>")("a").each((function(t,e){var n=(0,i.load)(e)(".title").text().trim(),r=!!(0,i.load)(e)(".cost").text().trim();if(!b.hideLocked||!r){var s;try{s=(0,a.default)((0,i.load)(e)(".date").text().trim(),"DD.MM.YYYY").toISOString()}catch(t){}var c=r?"ðŸ”’ "+n:n,u=e.attribs.href;h.push({name:c,path:u,page:o,releaseTime:s})}})),[2,{chapters:h.reverse()}]}}))}))},n.prototype.parseChapter=function(n){return t(this,void 0,void 0,(function(){var o,a,s,c,u,l,h,d,f=this;return e(this,(function(p){switch(p.label){case 0:return[4,(0,r.fetchApi)(this.site+n).then((function(t){return t.text()}))];case 1:return o=p.sent(),a=null===(h=null==o?void 0:o.match(/window\.CSRF_TOKEN = "([^"]+)"/))||void 0===h?void 0:h[1],s=null===(d=null==o?void 0:o.match(/const CHAPTER_ID = "([0-9]+)/))||void 0===d?void 0:d[1],[4,(0,r.fetchApi)(this.site+"book/ajax/read-chapter/"+s,{method:"GET",headers:{Cookie:"csrftoken="+a,Referer:this.site+n,"X-Requested-With":"XMLHttpRequest"}}).then((function(n){return t(f,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return[4,n.json()];case 1:return t=e.sent(),c=t.class,[2,t.content]}}))}))}))];case 2:return u=p.sent(),l=(0,i.load)(u),[2,(l("."+c).html()||"").replace(/class="advertisment"/g,'style="display:none;"')]}}))}))},n.prototype.searchNovels=function(n){return t(this,void 0,void 0,(function(){var t,a,s,c,u=this;return e(this,(function(e){switch(e.label){case 0:return t="".concat(this.site,"catalog/?search=").concat(encodeURIComponent(n)),[4,(0,r.fetchApi)(t).then((function(t){return t.text()}))];case 1:return a=e.sent(),s=(0,i.load)(a),c=[],s("a.item").each((function(t,e){var n=s(e).find("div.title").text().trim(),i=e.attribs.href,r=s(e).find("img").attr("src"),a=r?u.site+r:o.defaultCover;if(i){var l={name:n,cover:null!=a?a:o.defaultCover,path:i.replace("/","")};c.push(l)}})),[2,c]}}))}))},n}();exports.default=new u;