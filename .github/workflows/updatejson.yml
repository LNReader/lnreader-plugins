name: Update json files

on:
  push:
    branches:
      - PR_actions
      - plugins

jobs:
  make_json:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: '16'
    - name: Install dependencies
      run: npm install
 
    - name: Clean up current dist
      run: |
        rm -rf dist
        mkdir dist
        cat > config.json << EOF
        {
            "githubUsername": "LNReader",
            "githubRepository": "lnreader-sources",
            "githubBranch": "plugins"
        }
        EOF
      
    - name: Make json files
      id: json
      run: |
        node scripts/json_plugins.json
        echo "json-diff=$(git diff dist/LNReader/plugins.min.json)" > $GITHUB_OUTPUT

    - name: Create pull request
      if: ${{ steps.json.outputs.json-diff }}
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.REPO_SCOPED_TOKEN }}
        author: nyagami <hoangquan05112002@gmail.com>
        committer: nyagami <hoangquan05112002@gmail.com>
        commit-message: 'plugins: update json files for new plugins'
        title: Update json files
        labels: enhancement
        body: Auto-generated PR for updating json files
        branch: update-json
        delete-branch: true
